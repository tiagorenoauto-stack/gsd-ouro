<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GSD Ouro â€” Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',system-ui,sans-serif; background:#09090b; color:#e4e4e7; min-height:100vh; }
    .mono { font-family:'JetBrains Mono',monospace; }
    a { color:#fbbf24; text-decoration:none; }

    /* Layout */
    header { padding:16px 24px; border-bottom:1px solid #27272a; display:flex; align-items:center; justify-content:space-between; }
    nav { display:flex; gap:2px; border-bottom:1px solid #27272a; padding:0 24px; overflow-x:auto; position:sticky; top:0; z-index:10; background:#09090b; }
    nav button { padding:12px 16px; font-size:13px; border:none; background:none; color:#71717a; cursor:pointer; white-space:nowrap; border-bottom:2px solid transparent; font-family:inherit; }
    nav button:hover { color:#a1a1aa; }
    nav button.active { color:#fbbf24; border-bottom-color:#fbbf24; font-weight:600; }
    main { max-width:1200px; margin:0 auto; padding:24px; }
    footer { text-align:center; padding:16px; font-size:11px; color:#3f3f46; border-top:1px solid #18181b; margin-top:32px; }

    /* Grid */
    .grid4 { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }
    .grid2 { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
    .grid53 { display:grid; grid-template-columns:3fr 2fr; gap:16px; }
    .grid3c { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; text-align:center; }
    @media(max-width:768px) { .grid4,.grid2,.grid53,.grid3c { grid-template-columns:1fr; } }

    /* Cards */
    .card { background:#18181b; border:1px solid #27272a; border-radius:12px; padding:20px; }
    .card.glow { box-shadow:0 0 20px rgba(245,158,11,0.06); }
    .card h2 { font-size:12px; font-weight:600; color:#a1a1aa; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:12px; }
    .card .big { font-size:28px; font-weight:700; color:#fbbf24; }
    .card .sub { font-size:11px; color:#52525b; margin-top:4px; }
    .space > * + * { margin-top:16px; }

    /* Badges */
    .badge { display:inline-block; font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid; }
    .badge-green { background:rgba(34,197,94,0.1); color:#4ade80; border-color:rgba(34,197,94,0.2); }
    .badge-yellow { background:rgba(251,191,36,0.1); color:#fbbf24; border-color:rgba(251,191,36,0.2); }
    .badge-red { background:rgba(239,68,68,0.1); color:#f87171; border-color:rgba(239,68,68,0.2); }
    .badge-zinc { background:rgba(113,113,122,0.1); color:#a1a1aa; border-color:rgba(113,113,122,0.2); }
    .badge-blue { background:rgba(59,130,246,0.1); color:#60a5fa; border-color:rgba(59,130,246,0.2); }

    /* Bars */
    .bar-track { height:18px; background:#27272a; border-radius:9px; overflow:hidden; }
    .bar-fill { height:100%; border-radius:9px; transition:width 0.8s ease; }
    .phase-track { height:7px; background:#27272a; border-radius:4px; overflow:hidden; }
    .phase-fill { height:100%; border-radius:4px; }

    /* Table */
    table { width:100%; font-size:13px; border-collapse:collapse; }
    th { text-align:left; padding:10px 12px; color:#71717a; font-size:11px; font-weight:500; border-bottom:1px solid #27272a; }
    td { padding:10px 12px; border-bottom:1px solid #18181b; }
    tr:hover td { background:#1a1a1e; }
    .tc { text-align:center; }

    /* Alert boxes */
    .alert { font-size:13px; padding:10px 14px; border-radius:8px; border:1px solid; }
    .alert-warn { background:rgba(251,191,36,0.04); border-color:rgba(251,191,36,0.1); color:#fbbf24; }
    .alert-info { background:rgba(59,130,246,0.04); border-color:rgba(59,130,246,0.1); color:#60a5fa; }
    .alert-ok { background:rgba(34,197,94,0.04); border-color:rgba(34,197,94,0.1); color:#4ade80; }

    /* Prompt */
    textarea { width:100%; background:#1a1a1e; border:1px solid #27272a; border-radius:8px; padding:12px; color:#e4e4e7; font-size:13px; font-family:inherit; resize:none; height:80px; outline:none; }
    textarea:focus { border-color:#fbbf24; box-shadow:0 0 0 2px rgba(251,191,36,0.15); }
    select { background:#1a1a1e; border:1px solid #27272a; border-radius:8px; padding:6px 10px; color:#e4e4e7; font-size:12px; font-family:inherit; }
    .btn { padding:10px 20px; border:none; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; }
    .btn-gold { background:#f59e0b; color:#09090b; }
    .btn-gold:hover { background:#d97706; }
    .btn-sm { padding:6px 12px; font-size:11px; background:#27272a; color:#e4e4e7; border:1px solid #3f3f46; border-radius:8px; cursor:pointer; font-family:inherit; }
    pre.result { background:#09090b; border:1px solid #27272a; border-radius:8px; padding:14px; font-size:11px; color:#a1a1aa; white-space:pre-wrap; max-height:240px; overflow:auto; }

    /* Pages */
    .page { display:none; animation:fadeIn .3s ease; }
    .page.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

    /* Chart bars (CSS only) */
    .chart-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .chart-label { width:100px; font-size:11px; color:#71717a; flex-shrink:0; text-align:right; }
    .chart-bar { flex:1; height:14px; background:#27272a; border-radius:7px; overflow:hidden; }
    .chart-bar > div { height:100%; border-radius:7px; }
    .chart-val { width:60px; font-size:11px; text-align:right; flex-shrink:0; }

    /* Donut (CSS only) */
    .donut { width:160px; height:160px; border-radius:50%; position:relative; margin:0 auto; }
    .donut-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
    .legend { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:12px; font-size:11px; }
    .legend span::before { content:''; display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:4px; }

    /* Empty state */
    .empty { text-align:center; padding:28px 16px; color:#3f3f46; font-size:13px; }
    .empty small { color:#27272a; font-size:11px; display:block; margin-top:6px; }
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#fbbf24,#d97706);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#09090b">ğŸ†</div>
    <div><div style="font-size:16px;font-weight:700">GSD OURO</div><div style="font-size:11px;color:#52525b" id="hdr-projeto">Carregando...</div></div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="badge badge-yellow mono" id="hdr-sessao">â€”</span>
    <span style="width:6px;height:6px;border-radius:50%;background:#4ade80;display:inline-block" id="hdr-dot"></span>
    <span style="font-size:11px;color:#52525b" id="hdr-status">Conectando...</span>
  </div>
</header>

<nav id="nav">
  <button class="active" onclick="show('overview')">ğŸ  VisÃ£o Geral</button>
  <button onclick="show('costs')">ğŸ’° Economia</button>
  <button onclick="show('ias')">ğŸ¤– IAs</button>
  <button onclick="show('prompts')">âœ¨ Prompts</button>
  <button onclick="show('sessions')">ğŸ“… SessÃµes</button>
  <button onclick="show('quality')">âœ… Qualidade</button>
</nav>

<main class="space">
<!-- â•â•â• PAGE 1: VISÃƒO GERAL â•â•â• -->
<div id="p-overview" class="page active space">
  <div class="grid4">
    <div class="card glow"><h2>ğŸ“¦ Progresso</h2><div class="big mono" id="v-progresso">â€”</div><div class="sub" id="v-progresso-sub">carregando...</div></div>
    <div class="card glow"><h2>ğŸ’° Economia</h2><div class="big mono" id="v-economia">â€”</div><div class="sub" id="v-economia-sub">carregando...</div></div>
    <div class="card glow"><h2>âš¡ Velocidade</h2><div class="big mono" id="v-velocidade">â€”</div><div class="sub" id="v-velocidade-sub">carregando...</div></div>
    <div class="card glow"><h2>ğŸ¯ Qualidade</h2><div class="big mono" id="v-qualidade">â€”</div><div class="sub" id="v-qualidade-sub">carregando...</div></div>
  </div>
  <div class="grid53">
    <div class="card"><h2>ğŸ“ˆ Custo ao Longo do Tempo</h2>
      <div style="font-size:11px;color:#52525b;margin-bottom:8px">Vermelho=Se sÃ³ Claude | Amarelo=Custo real</div>
      <div id="chart-custos"></div>
    </div>
    <div class="card"><h2>ğŸ© DistribuiÃ§Ã£o IAs</h2><div id="chart-donut-ias"></div></div>
  </div>
  <div class="card"><h2>ğŸ—ºï¸ Timeline do Projeto</h2><div id="timeline"></div></div>
  <div class="card" style="border-color:rgba(251,191,36,0.2)"><h2 id="alertas-title">âš ï¸ Alertas</h2><div class="space" id="alertas-box"></div></div>
</div>

<!-- â•â•â• PAGE 2: ECONOMIA â•â•â• -->
<div id="p-costs" class="page space">
  <div class="card glow"><div class="grid3c">
    <div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Custo Real</div><div class="big mono" id="v-custo-real">â€”</div></div>
    <div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Se SÃ³ Claude</div><div class="big mono" style="color:#f87171" id="v-custo-hip">â€”</div></div>
    <div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Economia</div><div class="big mono" style="color:#4ade80" id="v-econ-valor">â€”</div><span class="badge badge-green mono" id="v-econ-badge">â€”</span></div>
  </div></div>
  <div class="grid2">
    <div class="card"><h2>ğŸ’³ Custo por IA</h2><div id="custoIA"></div></div>
    <div class="card"><h2>ğŸ¯ Custo por Fase</h2><div id="custoFase"></div></div>
  </div>
  <div class="card" style="border-color:rgba(34,197,94,0.2)"><h2>ğŸ”® ProjeÃ§Ã£o atÃ© ConclusÃ£o</h2><div class="grid3c" id="projecao"></div></div>
</div>

<!-- â•â•â• PAGE 3: IAs â•â•â• -->
<div id="p-ias" class="page space">
  <div class="card"><h2>ğŸ“Š Tabela Comparativa</h2><table><thead><tr><th>IA</th><th class="tc">Chamadas</th><th class="tc">Sucesso</th><th class="tc">LatÃªncia</th><th class="tc">Custo</th><th class="tc">Desvios</th></tr></thead><tbody id="tblIAs"></tbody></table></div>
  <div class="card"><h2>âš ï¸ RecomendaÃ§Ãµes</h2><div class="space" id="ias-recs"></div></div>
</div>

<!-- â•â•â• PAGE 4: PROMPTS â•â•â• -->
<div id="p-prompts" class="page space">
  <div class="card"><h2>âœ¨ O que vocÃª precisa?</h2>
    <textarea id="promptIn" placeholder='Escreva com suas palavras... ex: "preciso de um componente de upload de fotos"'></textarea>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div><label style="font-size:11px;color:#71717a;display:block;margin-bottom:4px">Tipo</label><select id="selTipo"><option>Auto</option><option>CÃ³digo</option><option>Doc</option><option>Debug</option><option>Teste</option></select></div>
      <div><label style="font-size:11px;color:#71717a;display:block;margin-bottom:4px">IA destino</label><select id="selIA"><option>Auto</option><option>Claude</option><option>Codestral</option><option>Gemini</option><option>DeepSeek</option></select></div>
      <div><label style="font-size:11px;color:#71717a;display:block;margin-bottom:4px">Modo</label><select id="selModo"><option>Completo</option><option>RÃ¡pido</option><option>Preview</option></select></div>
    </div>
    <button class="btn btn-gold" style="margin-top:12px" onclick="gerarPrompt()" id="btnGerar">ğŸš€ Gerar Prompt Otimizado</button>
  </div>
  <div id="promptRes" class="card" style="display:none;border-color:rgba(251,191,36,0.2)"><h2>ğŸ”§ Resultado</h2><div id="promptMeta" style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px"></div><pre class="result" id="promptOut"></pre>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap"><button class="btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('promptOut').textContent)">âœ… Copiar</button><button class="btn-sm">ğŸ“‹ Claude Code</button><button class="btn-sm">â­ Salvar</button><button class="btn-sm" onclick="gerarPrompt()">ğŸ”„ Regenerar</button></div>
  </div>
  <div class="card"><h2>ğŸ“œ HistÃ³rico</h2><div id="promptHist"></div></div>
</div>

<!-- â•â•â• PAGE 5: SESSÃ•ES â•â•â• -->
<div id="p-sessions" class="page space">
  <div class="card"><h2>ğŸ“… SessÃµes Recentes</h2><table><thead><tr><th>Data</th><th class="tc">DuraÃ§Ã£o</th><th class="tc">Tarefas</th><th class="tc">Custo</th><th>IAs</th></tr></thead><tbody id="tblSessoes"></tbody></table></div>
  <div class="card"><h2>ğŸ“– Legenda</h2><div style="display:flex;flex-wrap:wrap;gap:16px;font-size:11px;color:#71717a">
    <span><b class="mono" style="color:#e4e4e7">CS</b>=Claude Sonnet</span><span><b class="mono" style="color:#e4e4e7">CH</b>=Claude Haiku</span><span><b class="mono" style="color:#e4e4e7">CD</b>=Codestral</span><span><b class="mono" style="color:#e4e4e7">GM</b>=Gemini Pro</span><span><b class="mono" style="color:#e4e4e7">DS</b>=DeepSeek</span>
  </div></div>
</div>

<!-- â•â•â• PAGE 6: QUALIDADE â•â•â• -->
<div id="p-quality" class="page space">
  <div class="card glow"><h2>ğŸ¯ Conformidade Kit Ouro</h2>
    <div style="display:flex;align-items:center;gap:16px"><div style="flex:1;height:12px;background:#27272a;border-radius:6px;overflow:hidden"><div id="v-conform-bar" style="width:0%;height:100%;border-radius:6px;background:linear-gradient(90deg,#f59e0b,#eab308);transition:width .8s ease"></div></div><div class="big mono" style="font-size:24px" id="v-conform-pct">â€”</div></div>
  </div>
  <div class="card"><h2>ğŸ” Desvios Encontrados</h2><table><thead><tr><th>#</th><th>Tipo</th><th>IA</th><th class="tc">Fase</th><th>Status</th></tr></thead><tbody id="tblDesvios"></tbody></table></div>
  <div class="grid2">
    <div class="card"><h2>ğŸ© PadrÃ£o de Desvios</h2><div id="chart-donut-desvios"></div></div>
    <div class="card" style="border-color:rgba(251,191,36,0.2)"><h2>ğŸ’¡ RecomendaÃ§Ãµes</h2><div class="space" id="quality-recs"></div></div>
  </div>
</div>
</main>
<footer>GSD Ouro v0.1 â€” Dashboard Web â€” Dados em tempo real via API</footer>

<script>
/* â”€â”€ NavegaÃ§Ã£o â”€â”€ */
function show(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('p-'+id).classList.add('active');
  document.querySelectorAll('nav button').forEach((b,i)=>{
    const ids=['overview','costs','ias','prompts','sessions','quality'];
    b.classList.toggle('active',ids[i]===id);
  });
}
document.querySelectorAll('nav button').forEach((b,i)=>{
  const ids=['overview','costs','ias','prompts','sessions','quality'];
  b.onclick=()=>show(ids[i]);
});

/* â”€â”€ Helpers â”€â”€ */
const $=id=>document.getElementById(id);
const money=v=>'$'+(v||0).toFixed(2);
const pct=v=>(v||0).toFixed(1)+'%';
function emptyMsg(msg){return '<div class="empty">'+msg+'<small>Use /ouro:executar para registrar mÃ©tricas</small></div>';}

const IA_COLORS=['#fbbf24','#22c55e','#3b82f6','#a855f7','#ef4444','#06b6d4','#f97316','#ec4899'];
const IA_ABBR={'Claude Sonnet':'CS','Claude Haiku':'CH','Codestral':'CD','Gemini Pro':'GM','Gemini Flash':'GF','DeepSeek V3':'DS','DeepSeek R1':'DR','DeepSeek':'DS'};

/* â”€â”€ Estado â”€â”€ */
let D={},S=[],F=[],I=[],P=[];

/* â”€â”€ Fetch â”€â”€ */
async function load(){
  try{
    const [d,s,f,i,p]=await Promise.all([
      fetch('/api/dashboard').then(r=>r.json()).catch(()=>({})),
      fetch('/api/sessoes').then(r=>r.json()).catch(()=>[]),
      fetch('/api/fases').then(r=>r.json()).catch(()=>[]),
      fetch('/api/ias').then(r=>r.json()).catch(()=>[]),
      fetch('/api/prompts').then(r=>r.json()).catch(()=>[]),
    ]);
    D=d; S=s; F=f; I=i; P=p;
    $('hdr-dot').style.background='#4ade80';
    $('hdr-status').textContent='Ativo';
  }catch(e){
    console.error('Erro ao carregar dados:',e);
    $('hdr-dot').style.background='#f87171';
    $('hdr-status').textContent='Erro';
  }
  renderAll();
}

/* â”€â”€ Render â”€â”€ */
function renderAll(){
  renderHeader();
  renderOverview();
  renderCosts();
  renderIAsPage();
  renderPromptHist();
  renderSessions();
  renderQuality();
}

function renderHeader(){
  $('hdr-projeto').textContent=D.projeto||'Nenhum projeto configurado';
  $('hdr-sessao').textContent=D.sessoes?'SessÃ£o #'+D.sessoes:'Sem sessÃµes';
}

/* â”€â”€ P1: VisÃ£o Geral â”€â”€ */
function renderOverview(){
  // Cards
  $('v-progresso').textContent=D.progresso?pct(D.progresso):'0%';
  if(F.length){
    var done=F.filter(f=>f.status==='done').length;
    $('v-progresso-sub').textContent=done+' de '+F.length+' fases concluÃ­das';
  }else{
    $('v-progresso-sub').textContent=D.progresso>0?D.progresso+'% concluÃ­do':'nenhuma fase registrada';
  }

  $('v-economia').textContent=D.economia_pct?pct(D.economia_pct):'0%';
  var econSaved=(D.custo_hipotetico||0)-(D.custo_real||0);
  $('v-economia-sub').textContent=econSaved>0?money(econSaved)+' economizados':'sem dados de custo';

  // Velocidade â€” calculada das sessÃµes
  var veloc='â€”',velocSub='sem sessÃµes registradas';
  if(S.length){
    var totalT=S.reduce(function(a,s){return a+((s.tarefas&&s.tarefas.total)||0);},0);
    var totalH=S.reduce(function(a,s){return a+((s.duracao_segundos||0)/3600);},0);
    if(totalH>0){veloc=(totalT/totalH).toFixed(1)+'/h';velocSub=totalT+' tarefas em '+S.length+' sessÃµes';}
    else if(totalT>0){veloc=totalT+' tarefas';velocSub=S.length+' sessÃµes';}
  }
  $('v-velocidade').textContent=veloc;
  $('v-velocidade-sub').textContent=velocSub;

  $('v-qualidade').textContent=D.conformidade?pct(D.conformidade):'0%';
  $('v-qualidade-sub').textContent=D.conformidade>0?'conforme Kit Ouro':'sem verificaÃ§Ã£o';

  // GrÃ¡fico custo por sessÃ£o
  if(S.length){
    var maxH=Math.max.apply(null,S.map(function(s){return(s.custo&&s.custo.hipotetico)||0;}).concat([1]));
    $('chart-custos').innerHTML=S.slice(0,10).map(function(s,i){
      var hip=(s.custo&&s.custo.hipotetico)||0;
      var real=(s.custo&&s.custo.real)||0;
      var label=s.sessao_id||('S'+(i+1));
      return '<div class="chart-row"><div class="chart-label">'+label+'</div><div class="chart-bar"><div style="width:'+Math.max(hip/maxH*100,3)+'%;background:#ef4444"></div></div><div class="chart-val" style="color:#ef4444">'+money(hip)+'</div></div>'
        +'<div class="chart-row"><div class="chart-label"></div><div class="chart-bar"><div style="width:'+Math.max(real/maxH*100,3)+'%;background:#fbbf24"></div></div><div class="chart-val" style="color:#fbbf24">'+money(real)+'</div></div>';
    }).join('');
  }else{
    $('chart-custos').innerHTML=emptyMsg('Nenhuma sessÃ£o com dados de custo');
  }

  // Donut IAs
  if(I.length){
    var totalCalls=I.reduce(function(a,ia){return a+(ia.chamadas_total||0);},0);
    if(totalCalls>0){
      var acc=0;
      var parts=I.map(function(ia,idx){
        var p=ia.chamadas_total/totalCalls*100;
        var start=acc; acc+=p;
        return {nome:ia.nome,pct:p,start:start,color:IA_COLORS[idx%IA_COLORS.length]};
      });
      var conic=parts.map(function(p){return p.color+' '+p.start+'% '+(p.start+p.pct)+'%';}).join(',');
      $('chart-donut-ias').innerHTML='<div class="donut" style="background:conic-gradient('+conic+')"><div class="donut-center" style="width:80px;height:80px;background:#18181b;border-radius:50%;display:flex;align-items:center;justify-content:center"><span style="font-size:11px;color:#71717a">'+totalCalls+' calls</span></div></div>'
        +'<div class="legend">'+parts.map(function(p){return '<span style="color:'+p.color+'">â— '+p.nome+' '+p.pct.toFixed(0)+'%</span>';}).join('')+'</div>';
    }else{
      $('chart-donut-ias').innerHTML=emptyMsg('IAs registradas mas sem chamadas');
    }
  }else{
    $('chart-donut-ias').innerHTML=emptyMsg('Nenhuma IA registrada');
  }

  // Timeline fases
  if(F.length){
    var sorted=F.slice().sort(function(a,b){return(a.numero||0)-(b.numero||0);});
    $('timeline').innerHTML=sorted.map(function(f){
      var s=f.status||'pending';
      var p=f.progresso_pct||0;
      var icon=s==='done'?'âœ…':s==='current'?'ğŸ”„':'â³';
      var barColor=s==='done'?'#22c55e':s==='current'?'#fbbf24':'#3f3f46';
      var txtColor=s==='done'?'#4ade80':s==='current'?'#fbbf24':'#52525b';
      return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px"><span style="width:20px;font-size:11px;color:#52525b">'+(f.numero||'')+'</span><div class="phase-track" style="flex:1"><div class="phase-fill" style="width:'+p+'%;background:'+barColor+'"></div></div><span style="width:140px;font-size:11px;color:'+txtColor+'">'+icon+' '+(f.nome||'Fase '+f.numero)+'</span></div>';
    }).join('');
  }else{
    $('timeline').innerHTML=emptyMsg('Nenhuma fase registrada');
  }

  // Alertas
  var alertas=D.alertas||[];
  $('alertas-title').textContent=alertas.length?'âš ï¸ Alertas ('+alertas.length+' ativos)':'âš ï¸ Alertas';
  if(alertas.length){
    $('alertas-box').innerHTML=alertas.map(function(a){
      if(typeof a==='string') return '<div class="alert alert-warn">â€¢ '+a+'</div>';
      var cls=a.tipo==='warn'?'alert-warn':a.tipo==='ok'?'alert-ok':'alert-info';
      return '<div class="alert '+cls+'">â€¢ '+(a.mensagem||JSON.stringify(a))+'</div>';
    }).join('');
  }else{
    $('alertas-box').innerHTML='<div class="alert alert-ok">Nenhum alerta ativo</div>';
  }
}

/* â”€â”€ P2: Economia â”€â”€ */
function renderCosts(){
  $('v-custo-real').textContent=money(D.custo_real);
  $('v-custo-hip').textContent=money(D.custo_hipotetico);
  var econVal=(D.custo_hipotetico||0)-(D.custo_real||0);
  $('v-econ-valor').textContent=money(econVal);
  $('v-econ-badge').textContent=D.economia_pct?pct(D.economia_pct):'0%';

  // Custo por IA
  if(I.length){
    var maxC=Math.max.apply(null,I.map(function(ia){return ia.custo_total||0;}).concat([0.01]));
    $('custoIA').innerHTML=I.slice().sort(function(a,b){return(b.custo_total||0)-(a.custo_total||0);}).map(function(ia){
      var v=ia.custo_total||0;
      return '<div class="chart-row"><div class="chart-label">'+(ia.nome||'â€”')+'</div><div class="chart-bar"><div style="width:'+Math.max(v>0?v/maxC*100:3,3)+'%;background:'+(v>0?'#fbbf24':'#22c55e')+'"></div></div><div class="chart-val mono" style="color:'+(v>0?'#fbbf24':'#4ade80')+'">'+(v>0?money(v):'grÃ¡tis')+'</div></div>';
    }).join('');
  }else{
    $('custoIA').innerHTML=emptyMsg('Nenhuma IA registrada');
  }

  // Custo por fase
  if(F.length){
    var maxFC=Math.max.apply(null,F.map(function(f){return(f.custo&&f.custo.real)||0;}).concat([0.01]));
    $('custoFase').innerHTML=F.slice().sort(function(a,b){return((b.custo&&b.custo.real)||0)-((a.custo&&a.custo.real)||0);}).map(function(f){
      var v=(f.custo&&f.custo.real)||0;
      return '<div class="chart-row"><div class="chart-label">'+(f.nome||'Fase '+f.numero)+'</div><div class="chart-bar"><div style="width:'+Math.max(v>0?v/maxFC*100:3,3)+'%;background:'+(v>0?'#fbbf24':'#22c55e')+'"></div></div><div class="chart-val mono" style="color:'+(v>0?'#fbbf24':'#4ade80')+'">'+(v>0?money(v):'grÃ¡tis')+'</div></div>';
    }).join('');
  }else{
    $('custoFase').innerHTML=emptyMsg('Nenhuma fase registrada');
  }

  // ProjeÃ§Ã£o
  var prog=D.progresso||0;
  if(prog>0&&(D.custo_real||0)>0){
    var estReal=D.custo_real/(prog/100);
    var estHip=(D.custo_hipotetico||0)/(prog/100);
    var estEcon=estHip-estReal;
    var estPct=estHip>0?((estEcon/estHip)*100):0;
    $('projecao').innerHTML=
      '<div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Total Estimado</div><div style="font-size:22px;font-weight:700;color:#fbbf24" class="mono">'+money(estReal)+'</div></div>'
      +'<div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Sem Kit Ouro</div><div style="font-size:22px;font-weight:700;color:#f87171" class="mono">'+money(estHip)+'</div></div>'
      +'<div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Economia Projetada</div><div style="font-size:22px;font-weight:700;color:#4ade80" class="mono">'+money(estEcon)+'</div><span class="badge badge-green mono">'+pct(estPct)+'</span></div>';
  }else{
    $('projecao').innerHTML='<div style="grid-column:1/-1">'+emptyMsg('Precisa de progresso e custo para projetar')+'</div>';
  }
}

/* â”€â”€ P3: IAs â”€â”€ */
function renderIAsPage(){
  if(I.length){
    $('tblIAs').innerHTML=I.map(function(a){
      var suc=a.taxa_sucesso_pct||0;
      var lat=a.latencia_media_s?(a.latencia_media_s.toFixed(1)+'s'):'â€”';
      var custo=(a.custo_total||0)>0?money(a.custo_total):'grÃ¡tis';
      var custoC=(a.custo_total||0)>0?'#fbbf24':'#4ade80';
      var sucC=suc>=95?'#4ade80':suc>=90?'#fbbf24':'#f87171';
      var devC=(a.desvios_encontrados||0)===0?'#4ade80':'#f87171';
      return '<tr><td style="font-weight:500">'+a.nome+'</td><td class="tc mono">'+(a.chamadas_total||0)+'</td><td class="tc mono" style="color:'+sucC+'">'+pct(suc)+'</td><td class="tc mono">'+lat+'</td><td class="tc"><span class="mono" style="color:'+custoC+'">'+custo+'</span></td><td class="tc" style="color:'+devC+'">'+(a.desvios_encontrados||0)+'</td></tr>';
    }).join('');

    // RecomendaÃ§Ãµes automÃ¡ticas
    var recs=[];
    I.forEach(function(ia){
      if((ia.desvios_encontrados||0)>2) recs.push({t:'warn',m:ia.nome+': '+ia.desvios_encontrados+' desvios â€” considerar alternativa para tarefas sensÃ­veis'});
      if((ia.taxa_sucesso_pct||0)>=95&&(ia.custo_total||0)===0) recs.push({t:'ok',m:ia.nome+': '+pct(ia.taxa_sucesso_pct)+' sucesso a custo zero â€” excelente'});
      if((ia.taxa_sucesso_pct||0)<90) recs.push({t:'warn',m:ia.nome+': sucesso abaixo de 90% ('+pct(ia.taxa_sucesso_pct)+') â€” monitorar'});
    });
    $('ias-recs').innerHTML=recs.length?recs.map(function(r){return '<div class="alert alert-'+r.t+'">'+r.m+'</div>';}).join(''):'<div class="alert alert-ok">Todas as IAs operando normalmente</div>';
  }else{
    $('tblIAs').innerHTML='<tr><td colspan="6">'+emptyMsg('Nenhuma IA registrada')+'</td></tr>';
    $('ias-recs').innerHTML=emptyMsg('Sem dados para gerar recomendaÃ§Ãµes');
  }
}

/* â”€â”€ P4: Prompts â”€â”€ */
function renderPromptHist(){
  if(P.length){
    $('promptHist').innerHTML=P.slice(0,20).map(function(p){
      var time=p.timestamp?new Date(p.timestamp).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'â€”';
      var ok=p.resultado&&p.resultado.indexOf('âœ…')!==-1;
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #18181b"><span class="mono" style="font-size:11px;color:#52525b;width:40px">'+time+'</span><span style="font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">"'+(p.input_usuario||'â€”')+'"</span><span class="badge badge-zinc mono">'+(p.ia_destino||'â€”')+'</span><span style="font-size:11px;color:'+(ok?'#4ade80':'#fbbf24')+'">'+(ok?'âœ…':'âš ï¸')+'</span></div>';
    }).join('');
  }else{
    $('promptHist').innerHTML=emptyMsg('Nenhum prompt gerado ainda');
  }
}

/* â”€â”€ P5: SessÃµes â”€â”€ */
function renderSessions(){
  if(S.length){
    $('tblSessoes').innerHTML=S.slice(0,20).map(function(s){
      var data=s.timestamp?new Date(s.timestamp).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}):(s.sessao_id||'â€”');
      var secs=s.duracao_segundos||0;
      var dur=secs>0?(Math.floor(secs/3600)+'h'+String(Math.floor((secs%3600)/60)).padStart(2,'0')):'â€”';
      var tarefas=(s.tarefas&&s.tarefas.total)||0;
      var custo=(s.custo&&s.custo.real)||0;
      var iasHtml=(s.ias_utilizadas||[]).map(function(ia){
        var nome=ia.nome||'';
        var abbr=IA_ABBR[nome]||nome.slice(0,2).toUpperCase();
        return '<span class="badge badge-zinc mono">'+abbr+'</span> ';
      }).join('')||'â€”';
      return '<tr><td class="mono" style="color:#fbbf24;font-size:11px">'+data+(s.sessao_id?' #'+s.sessao_id.split('_').pop():'')+'</td><td class="tc mono" style="font-size:11px">'+dur+'</td><td class="tc mono" style="font-size:11px">'+tarefas+'</td><td class="tc mono" style="color:#fbbf24;font-size:11px">'+money(custo)+'</td><td style="font-size:11px">'+iasHtml+'</td></tr>';
    }).join('');
  }else{
    $('tblSessoes').innerHTML='<tr><td colspan="5">'+emptyMsg('Nenhuma sessÃ£o registrada')+'</td></tr>';
  }
}

/* â”€â”€ P6: Qualidade â”€â”€ */
function renderQuality(){
  var conf=D.conformidade||0;
  $('v-conform-bar').style.width=conf+'%';
  $('v-conform-pct').textContent=conf>0?pct(conf):'0%';

  // Coletar desvios de todas as IAs
  var desvios=[];
  var counter=1;
  I.forEach(function(ia){
    (ia.desvios_detalhados||[]).forEach(function(d){
      desvios.push({id:counter++,tipo:d.tipo||'â€”',ia:ia.nome,fase:d.fase||'â€”',status:d.status||'pendente'});
    });
  });

  if(desvios.length){
    $('tblDesvios').innerHTML=desvios.map(function(d){
      var badge=d.status==='corrigido'?'<span class="badge badge-green mono">âœ… corrigido</span>':'<span class="badge badge-yellow mono">â³ pendente</span>';
      return '<tr><td class="mono" style="color:#52525b;font-size:11px">'+d.id+'</td><td style="font-size:12px">'+d.tipo+'</td><td><span class="badge badge-zinc mono">'+d.ia+'</span></td><td class="tc mono" style="font-size:11px">'+d.fase+'</td><td>'+badge+'</td></tr>';
    }).join('');

    // Donut de padrÃ£o de desvios
    var tipos={};
    desvios.forEach(function(d){tipos[d.tipo]=(tipos[d.tipo]||0)+1;});
    var tipoArr=Object.keys(tipos).map(function(k){return{nome:k,count:tipos[k]};}).sort(function(a,b){return b.count-a.count;});
    var total=desvios.length;
    var acc2=0;
    var desvColors=['#ef4444','#fbbf24','#3b82f6','#6b7280','#a855f7','#06b6d4'];
    var parts2=tipoArr.map(function(t,i){var p2=t.count/total*100;var s2=acc2;acc2+=p2;return{nome:t.nome,pct:p2,start:s2,color:desvColors[i%desvColors.length]};});
    var conic2=parts2.map(function(p2){return p2.color+' '+p2.start+'% '+(p2.start+p2.pct)+'%';}).join(',');
    $('chart-donut-desvios').innerHTML='<div class="donut" style="background:conic-gradient('+conic2+')"><div class="donut-center" style="width:80px;height:80px;background:#18181b;border-radius:50%;display:flex;align-items:center;justify-content:center"><span style="font-size:11px;color:#71717a">'+total+' total</span></div></div>'
      +'<div class="legend">'+parts2.map(function(p2){return '<span style="color:'+p2.color+'">â— '+p2.nome+' '+p2.pct.toFixed(1)+'%</span>';}).join('')+'</div>';
  }else{
    $('tblDesvios').innerHTML='<tr><td colspan="5">'+emptyMsg('Nenhum desvio encontrado')+'</td></tr>';
    $('chart-donut-desvios').innerHTML=emptyMsg('Sem desvios para analisar');
  }

  // RecomendaÃ§Ãµes de qualidade
  if(I.length){
    var qrecs=[];
    var highDev=I.filter(function(ia){return(ia.desvios_encontrados||0)>2;});
    var zeroDev=I.filter(function(ia){return(ia.desvios_encontrados||0)===0&&(ia.chamadas_total||0)>5;});
    highDev.forEach(function(ia){qrecs.push({t:'warn',m:'<b>ReforÃ§ar padrÃµes para '+ia.nome+'</b><br><span style="color:#71717a">'+ia.desvios_encontrados+' desvios encontrados</span>'});});
    zeroDev.forEach(function(ia){qrecs.push({t:'ok',m:'<b>'+ia.nome+': excelente</b><br><span style="color:#52525b">0 desvios em '+(ia.chamadas_total||0)+' chamadas</span>'});});
    $('quality-recs').innerHTML=qrecs.length?qrecs.map(function(r){return '<div class="alert alert-'+r.t+'" style="font-size:12px">'+r.m+'</div>';}).join(''):'<div class="alert alert-ok">Sem recomendaÃ§Ãµes pendentes</div>';
  }else{
    $('quality-recs').innerHTML=emptyMsg('Sem dados para gerar recomendaÃ§Ãµes');
  }
}

/* â”€â”€ Gerador de Prompts (local) â”€â”€ */
function gerarPrompt(){
  var t=document.getElementById('promptIn').value.trim();
  if(!t)return;
  var b=document.getElementById('btnGerar');
  b.textContent='â³ Gerando...';b.disabled=true;
  setTimeout(function(){
    var tk=Math.floor(Math.random()*800+800);
    document.getElementById('promptMeta').innerHTML=
      '<span style="font-size:11px"><span style="color:#52525b">Otimizadora:</span> Gemini 2.5 Pro</span>'
      +'<span style="font-size:11px"><span style="color:#52525b">Destino:</span> <b style="color:#fbbf24">Codestral</b></span>'
      +'<span style="font-size:11px"><span style="color:#52525b">Framework:</span> RISE</span>'
      +'<span style="font-size:11px"><span style="color:#52525b">Tokens:</span> <span class="mono">~'+tk+'</span></span>'
      +'<span style="font-size:11px"><span style="color:#52525b">Custo:</span> <span class="mono" style="color:#4ade80">$0.00</span></span>';
    document.getElementById('promptOut').textContent='Role: Desenvolvedor React especializado\n\nInstructions:\n1. Usar APENAS componentes do Kit Ouro\n2. NÃƒO criar CSS custom â€” apenas TailwindCSS\n3. Seguir espaÃ§amento: p-4 para cards, gap-6 entre seÃ§Ãµes\n4. Responsivo: mobile-first\n5. Acessibilidade: labels, aria-labels, focus states\n\nContext: '+t.slice(0,60)+'...\n\nVerify:\nâ–¡ Componentes sÃ£o do Kit Ouro\nâ–¡ Nenhuma classe CSS fora do padrÃ£o\nâ–¡ Responsivo em mobile (320px) e desktop (1280px)';
    document.getElementById('promptRes').style.display='block';
    b.textContent='ğŸš€ Gerar Prompt Otimizado';b.disabled=false;
  },1500);
}

/* â”€â”€ Init â”€â”€ */
load();
setInterval(load,30000);
</script>
</body>
</html>
