<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GSD Ouro — Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI',system-ui,-apple-system,sans-serif; background:#09090b; color:#e4e4e7; min-height:100vh; }
    .mono { font-family:'Cascadia Code','JetBrains Mono','Fira Code',monospace; }

    /* Layout */
    header { padding:16px 24px; border-bottom:1px solid #27272a; display:flex; align-items:center; justify-content:space-between; }
    nav { display:flex; gap:2px; border-bottom:1px solid #27272a; padding:0 24px; overflow-x:auto; position:sticky; top:0; z-index:10; background:#09090b; }
    nav button { padding:12px 16px; font-size:13px; border:none; background:none; color:#71717a; cursor:pointer; white-space:nowrap; border-bottom:2px solid transparent; font-family:inherit; transition:color .2s; }
    nav button:hover { color:#a1a1aa; }
    nav button.active { color:#fbbf24; border-bottom-color:#fbbf24; font-weight:600; }
    nav button[data-pg="intelligence"].active { color:#818cf8; border-bottom-color:#6366f1; }
    nav button.hidden { display:none; }
    main { max-width:1200px; margin:0 auto; padding:24px; }
    footer { text-align:center; padding:16px; font-size:11px; color:#3f3f46; border-top:1px solid #18181b; margin-top:32px; }

    /* Grid */
    .g4 { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }
    .g3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    .g2 { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
    .g53 { display:grid; grid-template-columns:3fr 2fr; gap:16px; }
    .g3c { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; text-align:center; }
    @media(max-width:900px) { .g4 { grid-template-columns:repeat(2,1fr); } }
    @media(max-width:600px) { .g4,.g3,.g2,.g53,.g3c { grid-template-columns:1fr; } }

    /* Cards */
    .c { background:#18181b; border:1px solid #27272a; border-radius:12px; padding:20px; }
    .c.glow { box-shadow:0 0 20px rgba(245,158,11,0.06); }
    .c h2 { font-size:12px; font-weight:600; color:#a1a1aa; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:12px; }
    .c .big { font-size:28px; font-weight:700; color:#fbbf24; }
    .c .sub { font-size:11px; color:#52525b; margin-top:4px; }
    .sp > * + * { margin-top:16px; }

    /* Badges */
    .b { display:inline-block; font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid; }
    .b-g { background:rgba(34,197,94,0.1); color:#4ade80; border-color:rgba(34,197,94,0.2); }
    .b-y { background:rgba(251,191,36,0.1); color:#fbbf24; border-color:rgba(251,191,36,0.2); }
    .b-r { background:rgba(239,68,68,0.1); color:#f87171; border-color:rgba(239,68,68,0.2); }
    .b-z { background:rgba(113,113,122,0.1); color:#a1a1aa; border-color:rgba(113,113,122,0.2); }
    .b-b { background:rgba(59,130,246,0.1); color:#60a5fa; border-color:rgba(59,130,246,0.2); }

    /* Bars */
    .bar-t { height:18px; background:#27272a; border-radius:9px; overflow:hidden; }
    .bar-f { height:100%; border-radius:9px; transition:width 0.8s ease; }
    .ph-t { height:7px; background:#27272a; border-radius:4px; overflow:hidden; }
    .ph-f { height:100%; border-radius:4px; }

    /* Table */
    table { width:100%; font-size:13px; border-collapse:collapse; }
    th { text-align:left; padding:10px 12px; color:#71717a; font-size:11px; font-weight:500; border-bottom:1px solid #27272a; }
    td { padding:10px 12px; border-bottom:1px solid #18181b; }
    tr:hover td { background:#1a1a1e; }
    .tc { text-align:center; }

    /* Alerts */
    .al { font-size:13px; padding:10px 14px; border-radius:8px; border:1px solid; }
    .al-w { background:rgba(251,191,36,0.04); border-color:rgba(251,191,36,0.1); color:#fbbf24; }
    .al-i { background:rgba(59,130,246,0.04); border-color:rgba(59,130,246,0.1); color:#60a5fa; }
    .al-ok { background:rgba(34,197,94,0.04); border-color:rgba(34,197,94,0.1); color:#4ade80; }

    /* Inputs */
    textarea { width:100%; background:#1a1a1e; border:1px solid #27272a; border-radius:8px; padding:12px; color:#e4e4e7; font-size:13px; font-family:inherit; resize:none; height:80px; outline:none; }
    textarea:focus { border-color:#fbbf24; box-shadow:0 0 0 2px rgba(251,191,36,0.15); }
    select { background:#1a1a1e; border:1px solid #27272a; border-radius:8px; padding:6px 10px; color:#e4e4e7; font-size:12px; font-family:inherit; }
    .btn { padding:10px 20px; border:none; border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; }
    .btn-gold { background:#f59e0b; color:#09090b; }
    .btn-gold:hover { background:#d97706; }
    .btn-sm { padding:6px 12px; font-size:11px; background:#27272a; color:#e4e4e7; border:1px solid #3f3f46; border-radius:8px; cursor:pointer; font-family:inherit; }
    .btn-sm:hover { background:#3f3f46; }
    pre.result { background:#09090b; border:1px solid #27272a; border-radius:8px; padding:14px; font-size:11px; color:#a1a1aa; white-space:pre-wrap; max-height:240px; overflow:auto; }

    /* Pages */
    .pg { display:none; animation:fadeIn .3s ease; }
    .pg.active { display:block; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

    /* Chart rows */
    .cr { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
    .cl { width:100px; font-size:11px; color:#71717a; flex-shrink:0; text-align:right; }
    .cb { flex:1; height:14px; background:#27272a; border-radius:7px; overflow:hidden; }
    .cb > div { height:100%; border-radius:7px; }
    .cv { width:60px; font-size:11px; text-align:right; flex-shrink:0; }

    /* Donut */
    .donut { width:160px; height:160px; border-radius:50%; position:relative; margin:0 auto; }
    .donut-c { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
    .legend { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:12px; font-size:11px; }

    /* Empty */
    .em { text-align:center; padding:28px 16px; color:#3f3f46; font-size:13px; }
    .em small { color:#27272a; font-size:11px; display:block; margin-top:6px; }

    /* Chat tab */
    nav button[data-pg="chat"].active { color:#22d3ee; border-bottom-color:#22d3ee; }
    nav button[data-pg="comparator"].active { color:#f59e0b; border-bottom-color:#f59e0b; }

    /* Comparator */
    .cmp-tg { padding:4px 10px; font-size:11px; border-radius:12px; background:#1a1a1e; border:1px solid #27272a; color:#71717a; cursor:pointer; transition:all .2s; user-select:none; }
    .cmp-tg:hover { border-color:#52525b; color:#a1a1aa; }
    .cmp-tg.active { border-color:#f59e0b; color:#f59e0b; background:rgba(245,158,11,0.08); }
    .cmp-card { background:#18181b; border:1px solid #27272a; border-radius:12px; padding:16px; }
    .cmp-card.winner { border-color:#f59e0b; box-shadow:0 0 12px rgba(245,158,11,0.1); }
    .cmp-score { font-size:28px; font-weight:700; }
    .cmp-bar { height:6px; background:#27272a; border-radius:3px; margin:2px 0; }
    .cmp-bar-fill { height:100%; border-radius:3px; transition:width 0.8s ease; }
    .chat-msg { padding:8px 12px; margin-bottom:6px; border-radius:8px; font-size:13px; line-height:1.5; }
    .chat-user { background:#1a1a2e; border:1px solid #27272a; text-align:right; }
    .chat-ai { background:rgba(34,211,238,0.05); border:1px solid rgba(34,211,238,0.15); }
    .chat-ai .chat-label { color:#22d3ee; font-size:10px; font-weight:600; text-transform:uppercase; margin-bottom:2px; }
    .chat-user .chat-label { color:#71717a; font-size:10px; font-weight:600; text-transform:uppercase; margin-bottom:2px; text-align:right; }

    /* Notes */
    .note-item { padding:10px 14px; border:1px solid #27272a; border-radius:8px; margin-bottom:6px; background:#18181b; display:flex; gap:10px; align-items:flex-start; }
    .note-item:hover { border-color:#3f3f46; }
    .note-text { flex:1; font-size:13px; line-height:1.4; }
    .note-tags { display:flex; gap:4px; flex-wrap:wrap; margin-top:4px; }
    .note-tag { font-size:9px; padding:1px 6px; border-radius:999px; background:rgba(251,191,36,0.1); color:#fbbf24; border:1px solid rgba(251,191,36,0.15); }
    .note-tag.t-bug { background:rgba(239,68,68,0.1); color:#f87171; border-color:rgba(239,68,68,0.15); }
    .note-tag.t-feature { background:rgba(59,130,246,0.1); color:#60a5fa; border-color:rgba(59,130,246,0.15); }
    .note-tag.t-idea { background:rgba(168,85,247,0.1); color:#c084fc; border-color:rgba(168,85,247,0.15); }
    .note-tag.t-ui { background:rgba(34,211,238,0.1); color:#22d3ee; border-color:rgba(34,211,238,0.15); }
    .note-prio { font-size:10px; font-weight:600; flex-shrink:0; }
    .prio-high { color:#f87171; }
    .prio-medium { color:#fbbf24; }
    .prio-low { color:#71717a; }
    .note-actions { display:flex; gap:4px; flex-shrink:0; }
    .note-actions button { background:none; border:1px solid #27272a; color:#71717a; font-size:10px; padding:2px 6px; border-radius:4px; cursor:pointer; }
    .note-actions button:hover { color:#e4e4e7; border-color:#52525b; }

    /* Updates */
    .upd-item { padding:12px 16px; border-left:3px solid #fbbf24; background:#18181b; border-radius:0 8px 8px 0; margin-bottom:8px; }
    .upd-item.t-hotfix { border-left-color:#f87171; }
    .upd-item.t-patch { border-left-color:#60a5fa; }

    /* Mode indicator */
    .mode-pill { display:inline-flex; align-items:center; gap:6px; padding:4px 12px; border-radius:999px; font-size:11px; font-weight:600; }
    .mode-claude { background:rgba(251,191,36,0.1); color:#fbbf24; border:1px solid rgba(251,191,36,0.2); }
    .mode-economico { background:rgba(34,197,94,0.1); color:#4ade80; border:1px solid rgba(34,197,94,0.2); }

    /* Stat mini cards */
    .stat { text-align:center; padding:16px; }
    .stat .val { font-size:24px; font-weight:700; }
    .stat .lbl { font-size:11px; color:#71717a; margin-top:4px; }

    /* Streak */
    .streak { display:flex; gap:4px; justify-content:center; flex-wrap:wrap; }
    .streak .day { width:14px; height:14px; border-radius:3px; }
    .streak .day.active { background:#fbbf24; }
    .streak .day.empty { background:#27272a; }

    /* ═══ Intelligence Tab ═══ */
    .kpi-card { background:#18181b; border:1px solid rgba(99,102,241,0.25); border-radius:12px; padding:20px; text-align:center; position:relative; overflow:hidden; }
    .kpi-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,#6366f1,#818cf8); }
    .kpi-card .kpi-value { font-size:32px; font-weight:700; color:#818cf8; }
    .kpi-card .kpi-label { font-size:11px; color:#71717a; text-transform:uppercase; letter-spacing:0.5px; margin-top:4px; }

    .glass-card { background:linear-gradient(135deg,rgba(99,102,241,0.06),rgba(99,102,241,0.02)); border:1px solid rgba(99,102,241,0.25); border-radius:16px; padding:24px; }
    .glass-card h2 { font-size:13px; font-weight:600; color:#818cf8; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:16px; }

    .progress-ring { width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; position:relative; }
    .ring-inner { width:56px; height:56px; background:#18181b; border-radius:50%; display:flex; align-items:center; justify-content:center; position:absolute; }
    .ring-value { font-size:20px; font-weight:700; color:#e4e4e7; z-index:1; }

    .cat-badge { display:inline-block; font-size:10px; padding:2px 10px; border-radius:999px; font-weight:600; text-transform:uppercase; letter-spacing:0.3px; border:1px solid; }
    .cat-perf { background:rgba(34,197,94,0.1); color:#4ade80; border-color:rgba(34,197,94,0.2); }
    .cat-qual { background:rgba(59,130,246,0.1); color:#60a5fa; border-color:rgba(59,130,246,0.2); }
    .cat-org { background:rgba(168,85,247,0.1); color:#a855f7; border-color:rgba(168,85,247,0.2); }
    .cat-prev { background:rgba(239,68,68,0.1); color:#f87171; border-color:rgba(239,68,68,0.2); }
    .cat-econ { background:rgba(251,191,36,0.1); color:#fbbf24; border-color:rgba(251,191,36,0.2); }

    .sev-badge { display:inline-block; font-size:10px; padding:2px 8px; border-radius:999px; font-weight:600; }
    .sev-critical { background:rgba(239,68,68,0.1); color:#f87171; }
    .sev-high { background:rgba(249,115,22,0.1); color:#f97316; }
    .sev-medium { background:rgba(251,191,36,0.1); color:#fbbf24; }
    .sev-low { background:rgba(34,197,94,0.1); color:#4ade80; }

    .diff-dots { display:inline-flex; gap:2px; }
    .diff-dots span { display:inline-block; width:8px; height:8px; border-radius:50%; }
    .diff-dots .filled { background:#818cf8; }
    .diff-dots .empty { background:#27272a; }

    .intel-border { border-color:rgba(99,102,241,0.25) !important; }
    .intel-border h2 { color:#818cf8 !important; }

    @keyframes fadeInUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:none} }
    .animate-in { animation:fadeInUp 0.4s ease backwards; }

    .tip-card { display:flex; gap:12px; align-items:flex-start; padding:12px 0; border-bottom:1px solid rgba(99,102,241,0.1); }
    .tip-card:last-child { border-bottom:none; }
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <div style="width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#fbbf24,#d97706);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#09090b">G</div>
    <div>
      <div style="font-size:16px;font-weight:700">GSD OURO</div>
      <div style="font-size:11px;color:#52525b" id="hdr-proj">Carregando...</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <span id="hdr-mode" class="mode-pill mode-claude">CLAUDE</span>
    <span class="b b-y mono" id="hdr-sess">--</span>
    <span style="width:6px;height:6px;border-radius:50%;background:#4ade80;display:inline-block" id="hdr-dot"></span>
    <span style="font-size:11px;color:#52525b" id="hdr-st">Conectando...</span>
  </div>
</header>

<nav id="nav">
  <button class="active" data-pg="overview">Visao Geral</button>
  <button data-pg="productivity">Produtividade</button>
  <button data-pg="costs" data-eco="1">Economia</button>
  <button data-pg="providers" data-eco="1">Providers</button>
  <button data-pg="prompts">Prompts</button>
  <button data-pg="sessions">Sessoes</button>
  <button data-pg="quality">Qualidade</button>
  <button data-pg="intelligence" style="color:#6366f1">Inteligencia</button>
  <button data-pg="chat" style="color:#22d3ee">Chat</button>
  <button data-pg="notes">Notas</button>
  <button data-pg="updates">Updates</button>
  <button data-pg="comparator" style="color:#f59e0b">Comparacao</button>
</nav>

<main class="sp">

<!-- ═══ VISAO GERAL ═══ -->
<div id="p-overview" class="pg active sp">
  <div class="g4">
    <div class="c glow"><h2>Progresso</h2><div class="big mono" id="v-prog">--</div><div class="sub" id="v-prog-s">carregando...</div></div>
    <div class="c glow"><h2>Tarefas</h2><div class="big mono" id="v-tasks">--</div><div class="sub" id="v-tasks-s">carregando...</div></div>
    <div class="c glow"><h2>Velocidade</h2><div class="big mono" id="v-vel">--</div><div class="sub" id="v-vel-s">carregando...</div></div>
    <div class="c glow"><h2>Qualidade</h2><div class="big mono" id="v-qual">--</div><div class="sub" id="v-qual-s">carregando...</div></div>
  </div>
  <div class="g53">
    <div class="c"><h2>Timeline do Projeto</h2><div id="timeline"></div></div>
    <div class="c"><h2>Resumo do Projeto</h2>
      <div class="sp" id="proj-summary">
        <div style="font-size:12px;color:#71717a">Modo: <span id="sum-mode" style="color:#fbbf24">--</span></div>
        <div style="font-size:12px;color:#71717a">Sessoes: <span id="sum-sess" class="mono" style="color:#e4e4e7">--</span></div>
        <div style="font-size:12px;color:#71717a">Fases: <span id="sum-fases" class="mono" style="color:#e4e4e7">--</span></div>
        <div style="font-size:12px;color:#71717a">Custo total: <span id="sum-custo" class="mono" style="color:#fbbf24">--</span></div>
        <div style="font-size:12px;color:#71717a">Economia: <span id="sum-econ" class="mono" style="color:#4ade80">--</span></div>
      </div>
    </div>
  </div>
  <div class="c" style="border-color:rgba(251,191,36,0.2)"><h2 id="alerts-t">Alertas</h2><div class="sp" id="alerts-box"></div></div>
</div>

<!-- ═══ PRODUTIVIDADE ═══ -->
<div id="p-productivity" class="pg sp">
  <div class="g4">
    <div class="c glow"><h2>Tarefas Hoje</h2><div class="big mono" id="pr-today">0</div><div class="sub">concluidas hoje</div></div>
    <div class="c glow"><h2>Tarefas Semana</h2><div class="big mono" id="pr-week">0</div><div class="sub">ultimos 7 dias</div></div>
    <div class="c glow"><h2>Velocidade Media</h2><div class="big mono" id="pr-speed">--</div><div class="sub">tarefas/hora</div></div>
    <div class="c glow"><h2>Streak</h2><div class="big mono" id="pr-streak">0</div><div class="sub" id="pr-streak-s">dias consecutivos</div></div>
  </div>
  <div class="g2">
    <div class="c"><h2>Atividade (ultimos 14 dias)</h2><div class="streak" id="pr-heatmap"></div><div style="margin-top:12px" id="pr-activity"></div></div>
    <div class="c"><h2>Tarefas por Fase</h2><div id="pr-by-phase"></div></div>
  </div>
  <div class="g2">
    <div class="c"><h2>Top Metricas</h2>
      <table><thead><tr><th>Metrica</th><th class="tc">Valor</th><th class="tc">Meta</th><th class="tc">Status</th></tr></thead>
      <tbody id="pr-metrics"></tbody></table>
    </div>
    <div class="c"><h2>Sessoes Recentes</h2><div id="pr-recent"></div></div>
  </div>
</div>

<!-- ═══ ECONOMIA (modo economico) ═══ -->
<div id="p-costs" class="pg sp">
  <div class="c glow"><div class="g3c">
    <div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Custo Real</div><div class="big mono" id="ec-real">--</div></div>
    <div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Se So Claude</div><div class="big mono" style="color:#f87171" id="ec-hip">--</div></div>
    <div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Economia</div><div class="big mono" style="color:#4ade80" id="ec-save">--</div><span class="b b-g mono" id="ec-pct">--</span></div>
  </div></div>
  <div class="g2">
    <div class="c"><h2>Custo por IA</h2><div id="ec-by-ia"></div></div>
    <div class="c"><h2>Custo por Fase</h2><div id="ec-by-fase"></div></div>
  </div>
  <div class="c" style="border-color:rgba(34,197,94,0.2)"><h2>Projecao ate Conclusao</h2><div class="g3c" id="ec-proj"></div></div>
</div>

<!-- ═══ PROVIDERS (modo economico) ═══ -->
<div id="p-providers" class="pg sp">
  <div class="c"><h2>Tabela Comparativa</h2>
    <table><thead><tr><th>Provider</th><th class="tc">Chamadas</th><th class="tc">Sucesso</th><th class="tc">Latencia</th><th class="tc">Custo</th><th class="tc">Desvios</th></tr></thead>
    <tbody id="tbl-ias"></tbody></table>
  </div>
  <div class="c"><h2>Recomendacoes</h2><div class="sp" id="ias-recs"></div></div>
</div>

<!-- ═══ PROMPTS ═══ -->
<div id="p-prompts" class="pg sp">
  <div class="c"><h2>O que voce precisa?</h2>
    <textarea id="promptIn" placeholder='Escreva com suas palavras... ex: "preciso de um componente de upload de fotos"'></textarea>
    <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
      <div><label style="font-size:11px;color:#71717a;display:block;margin-bottom:4px">Tipo</label><select id="selTipo"><option>Auto</option><option>Codigo</option><option>Doc</option><option>Debug</option><option>Teste</option></select></div>
      <div><label style="font-size:11px;color:#71717a;display:block;margin-bottom:4px">Modo</label><select id="selModo"><option>Completo</option><option>Rapido</option><option>Preview</option></select></div>
    </div>
    <button class="btn btn-gold" style="margin-top:12px" onclick="gerarPrompt()" id="btnGerar">Gerar Prompt Otimizado</button>
  </div>
  <div id="promptRes" class="c" style="display:none;border-color:rgba(251,191,36,0.2)"><h2>Resultado</h2><div id="promptMeta" style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px"></div><pre class="result" id="promptOut"></pre>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap"><button class="btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('promptOut').textContent)">Copiar</button><button class="btn-sm" onclick="gerarPrompt()">Regenerar</button></div>
  </div>
  <div class="c"><h2>Historico</h2><div id="promptHist"></div></div>
</div>

<!-- ═══ SESSOES ═══ -->
<div id="p-sessions" class="pg sp">
  <div class="c"><h2>Sessoes Recentes</h2>
    <table><thead><tr><th>Data</th><th class="tc">Duracao</th><th class="tc">Tarefas</th><th class="tc">Custo</th><th>IAs</th></tr></thead>
    <tbody id="tbl-sess"></tbody></table>
  </div>
</div>

<!-- ═══ QUALIDADE ═══ -->
<div id="p-quality" class="pg sp">
  <div class="c glow"><h2>Conformidade Kit Ouro</h2>
    <div style="display:flex;align-items:center;gap:16px"><div style="flex:1;height:12px;background:#27272a;border-radius:6px;overflow:hidden"><div id="q-bar" style="width:0%;height:100%;border-radius:6px;background:linear-gradient(90deg,#f59e0b,#eab308);transition:width .8s ease"></div></div><div class="big mono" style="font-size:24px" id="q-pct">--</div></div>
  </div>
  <div class="c"><h2>Desvios Encontrados</h2>
    <table><thead><tr><th>#</th><th>Tipo</th><th>IA</th><th class="tc">Fase</th><th>Status</th></tr></thead>
    <tbody id="tbl-dev"></tbody></table>
  </div>
  <div class="g2">
    <div class="c"><h2>Padrao de Desvios</h2><div id="ch-dev"></div></div>
    <div class="c" style="border-color:rgba(251,191,36,0.2)"><h2>Recomendacoes</h2><div class="sp" id="q-recs"></div></div>
  </div>
</div>

<!-- ═══ INTELIGENCIA ═══ -->
<div id="p-intelligence" class="pg sp">
  <!-- KPI Row -->
  <div class="g4">
    <div class="kpi-card animate-in">
      <div class="progress-ring" id="intel-health-ring"><div class="ring-inner"><span class="ring-value mono" id="intel-health-val">--</span></div></div>
      <div class="kpi-label">Health Score</div>
    </div>
    <div class="kpi-card animate-in" style="animation-delay:0.1s">
      <div class="kpi-value mono" id="intel-errors-count">0</div>
      <div class="kpi-label">Erros Rastreados</div>
    </div>
    <div class="kpi-card animate-in" style="animation-delay:0.2s">
      <div class="kpi-value mono" id="intel-prevention-count">0</div>
      <div class="kpi-label">Regras Prevencao</div>
    </div>
    <div class="kpi-card animate-in" style="animation-delay:0.3s">
      <div class="kpi-value mono" id="intel-tips-count">0</div>
      <div class="kpi-label">Tips Disponiveis</div>
    </div>
  </div>

  <!-- AI Insights -->
  <div class="glass-card animate-in" style="animation-delay:0.15s">
    <h2>AI Insights</h2>
    <div id="intel-insights" class="sp"></div>
  </div>

  <!-- Error Distribution + Recent Errors -->
  <div class="g53">
    <div class="c intel-border animate-in" style="animation-delay:0.2s">
      <h2>Distribuicao de Erros</h2>
      <div id="intel-error-dist"></div>
    </div>
    <div class="c intel-border animate-in" style="animation-delay:0.25s">
      <h2>Erros Recentes</h2>
      <div id="intel-recent-errors" style="max-height:300px;overflow-y:auto"></div>
    </div>
  </div>

  <!-- Prevention Rules + Error Trends -->
  <div class="g2">
    <div class="c intel-border animate-in" style="animation-delay:0.3s">
      <h2>Regras de Prevencao</h2>
      <table><thead><tr><th>Regra</th><th class="tc">Severidade</th><th class="tc">Matches</th></tr></thead>
      <tbody id="intel-prevention-tbl"></tbody></table>
    </div>
    <div class="c intel-border animate-in" style="animation-delay:0.35s">
      <h2>Tendencia de Erros (14 dias)</h2>
      <div id="intel-error-trend"></div>
    </div>
  </div>

  <!-- Health Sub-scores -->
  <div class="c intel-border animate-in" style="animation-delay:0.4s">
    <h2>Sub-Scores de Saude</h2>
    <div id="intel-subscores"></div>
  </div>
</div>

<!-- ═══ CHAT INTERATIVO ═══ -->
<div id="p-chat" class="pg sp">
  <div class="g2">
    <div class="c" style="border-color:rgba(34,211,238,0.2)">
      <h2 style="color:#22d3ee">Chat — Linguagem Natural para Prompt</h2>
      <div id="chat-messages" style="min-height:280px;max-height:400px;overflow-y:auto;margin-bottom:12px;padding:8px;background:#09090b;border-radius:8px;border:1px solid #27272a">
        <div class="em" id="chat-empty">Escreva o que voce quer em linguagem natural.<br><small>Ex: "quero um botao de logout bonito no header"</small></div>
      </div>
      <div style="display:flex;gap:8px">
        <textarea id="chatIn" placeholder="Descreva o que voce quer..." style="height:44px;flex:1"></textarea>
        <button class="btn btn-gold" onclick="sendChat()" style="white-space:nowrap">Enviar</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button class="btn-sm" onclick="clearChat()">Limpar</button>
        <span id="chat-status" style="font-size:11px;color:#52525b;line-height:32px;margin-left:8px"></span>
      </div>
    </div>
    <div class="c">
      <h2>Prompt Gerado</h2>
      <pre class="result" id="chat-prompt" style="min-height:280px">Nenhum prompt gerado ainda.
Converse no chat para gerar um prompt CO-STAR profissional.</pre>
      <div style="margin-top:8px;display:flex;gap:6px">
        <button class="btn-sm" onclick="copyChatPrompt()">Copiar</button>
        <button class="btn-sm" onclick="saveChatPrompt()">Salvar</button>
      </div>
    </div>
  </div>
  <div class="c" style="margin-top:16px">
    <h2>Configuracao do Chat</h2>
    <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
      <label style="font-size:12px;color:#71717a;display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="chat-confirm-toggle" onchange="toggleConfirm()" checked>
        <span>CONFIRM Before Code ativo</span>
      </label>
      <span style="font-size:11px;color:#3f3f46" id="confirm-status">Padrao: ON — Bloco CONFIRM obrigatorio antes de codificar</span>
    </div>
  </div>
</div>

<!-- ═══ NOTAS ═══ -->
<div id="p-notes" class="pg sp">
  <div class="g53">
    <div class="c">
      <h2>Notas</h2>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <textarea id="noteIn" placeholder="Escreva sua ideia, bug, feature..." style="height:44px;flex:1"></textarea>
        <button class="btn btn-gold" onclick="addNote()" style="white-space:nowrap">+ Nota</button>
      </div>
      <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
        <button class="btn-sm" onclick="filterNotes()" data-nf="all" style="background:#3f3f46">Todas</button>
        <button class="btn-sm" onclick="filterNotes('high')">Urgentes</button>
        <button class="btn-sm" onclick="filterNotes('open')">Abertas</button>
        <button class="btn-sm" onclick="filterNotes('done')">Feitas</button>
      </div>
      <div id="notes-list" style="max-height:400px;overflow-y:auto">
        <div class="em">Nenhuma nota. Adicione sua primeira ideia!</div>
      </div>
    </div>
    <div class="c">
      <h2>Estatisticas</h2>
      <div id="notes-stats" class="sp">
        <div class="em">Sem dados</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ COMPARACAO MULTI-IA ═══ -->
<div id="p-comparator" class="pg sp">
  <div class="g2">
    <div class="c" style="border-color:rgba(245,158,11,0.3)">
      <h2 style="color:#f59e0b">Comparar IAs</h2>
      <div class="sp">
        <textarea id="cmp-prompt" placeholder="Digite o prompt para comparar entre IAs..." style="height:80px"></textarea>
        <div class="g2" style="gap:8px">
          <select id="cmp-preset" style="flex:1" onchange="applyPreset()">
            <option value="">Preset...</option>
            <option value="codigo">Codigo</option>
            <option value="debug">Debug</option>
            <option value="documentacao">Documentacao</option>
            <option value="refactor">Refactor</option>
            <option value="rapido">Rapido</option>
          </select>
          <select id="cmp-cat" style="flex:1">
            <option value="">Categoria (auto)</option>
            <option value="codigo">Codigo</option>
            <option value="debug">Debug</option>
            <option value="refactor">Refactor</option>
            <option value="testes">Testes</option>
            <option value="documentacao">Documentacao</option>
            <option value="geral">Geral</option>
          </select>
        </div>
        <div id="cmp-targets" style="margin-top:8px">
          <div style="font-size:11px;color:#71717a;margin-bottom:4px">Targets (provider:model)</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap" id="cmp-target-list">
            <span class="cmp-tg active" data-t="deepseek:deepseek-chat" onclick="toggleTarget(this)">DeepSeek</span>
            <span class="cmp-tg active" data-t="google:gemini-2.5-flash" onclick="toggleTarget(this)">Gemini Flash</span>
            <span class="cmp-tg" data-t="mistral:codestral-latest" onclick="toggleTarget(this)">Codestral</span>
            <span class="cmp-tg" data-t="groq:llama-3.1-8b-instant" onclick="toggleTarget(this)">Groq Llama</span>
          </div>
        </div>
        <button class="btn btn-gold" onclick="runComparison()" id="btn-compare" style="margin-top:8px;width:100%">Comparar</button>
        <div id="cmp-status" style="font-size:11px;color:#71717a;margin-top:4px"></div>
      </div>
    </div>
    <div class="c">
      <h2>Ranking Global</h2>
      <div id="cmp-ranking">
        <div class="em">Execute comparacoes para gerar ranking</div>
      </div>
    </div>
  </div>

  <div id="cmp-results-section" style="display:none;margin-top:16px">
    <div class="c" style="border-color:rgba(245,158,11,0.2)">
      <h2>Resultado da Comparacao</h2>
      <div id="cmp-winner" style="margin-bottom:16px"></div>
      <div class="g2" id="cmp-cards"></div>
    </div>
  </div>

  <div class="g2" style="margin-top:16px">
    <div class="c">
      <h2>Historico de Comparacoes</h2>
      <div id="cmp-history">
        <div class="em">Sem comparacoes ainda</div>
      </div>
    </div>
    <div class="c">
      <h2>Recomendacoes</h2>
      <div id="cmp-recommendations">
        <div class="em">Execute comparacoes para obter recomendacoes</div>
      </div>
    </div>
  </div>
</div>

<!-- ═══ UPDATES ═══ -->
<div id="p-updates" class="pg sp">
  <div class="c" style="border-color:rgba(251,191,36,0.2)">
    <h2>Historico de Atualizacoes — GSD Ouro</h2>
    <div id="updates-list" class="sp">
      <div class="em">Carregando historico...</div>
    </div>
  </div>
  <div class="g2" style="margin-top:16px">
    <div class="c">
      <h2>Registrar Atualizacao</h2>
      <div class="sp">
        <input type="text" id="upd-version" placeholder="Versao (ex: 0.7.0)" style="width:100%;background:#1a1a1e;border:1px solid #27272a;border-radius:8px;padding:8px 12px;color:#e4e4e7;font-size:13px;font-family:inherit">
        <textarea id="upd-desc" placeholder="Descricao da atualizacao..." style="height:60px"></textarea>
        <div style="display:flex;gap:8px">
          <select id="upd-type" style="flex:1">
            <option value="release">Release</option>
            <option value="hotfix">Hotfix</option>
            <option value="patch">Patch</option>
            <option value="update">Update</option>
          </select>
          <button class="btn btn-gold" onclick="logUpdate()">Registrar</button>
        </div>
      </div>
    </div>
    <div class="c">
      <h2>Resumo</h2>
      <div id="updates-summary" class="sp">
        <div class="em">Sem dados</div>
      </div>
    </div>
  </div>
</div>

</main>
<footer>GSD Ouro v0.8 — Dashboard Adaptativo + Multi-IA — Modo <span id="ft-mode">claude</span></footer>

<script>
/* ── State ── */
var D={},S=[],F=[],I=[],P=[],MODO='claude';
var ERRORS=[],PREV=[],HEALTH={},TIPS=[];

/* ── Helpers ── */
var $=function(id){return document.getElementById(id)};
var money=function(v){return '$'+(v||0).toFixed(2)};
var pct=function(v){return (v||0).toFixed(1)+'%'};
var em=function(msg){return '<div class="em">'+msg+'<small>Use /ouro:executar para registrar metricas</small></div>'};
var COLORS=['#fbbf24','#22c55e','#3b82f6','#a855f7','#ef4444','#06b6d4','#f97316','#ec4899'];

/* ── Navigation ── */
document.querySelectorAll('nav button').forEach(function(btn){
  btn.onclick=function(){
    var pg=btn.getAttribute('data-pg');
    document.querySelectorAll('.pg').forEach(function(p){p.classList.remove('active')});
    document.getElementById('p-'+pg).classList.add('active');
    document.querySelectorAll('nav button').forEach(function(b){b.classList.remove('active')});
    btn.classList.add('active');
  };
});

function updateNavVisibility(){
  document.querySelectorAll('nav button[data-eco]').forEach(function(btn){
    btn.classList.toggle('hidden',MODO!=='economico');
  });
}

/* ── Fetch ── */
async function load(){
  try{
    var results=await Promise.all([
      fetch('/api/dashboard').then(function(r){return r.json()}).catch(function(){return {}}),
      fetch('/api/sessoes').then(function(r){return r.json()}).catch(function(){return []}),
      fetch('/api/fases').then(function(r){return r.json()}).catch(function(){return []}),
      fetch('/api/ias').then(function(r){return r.json()}).catch(function(){return []}),
      fetch('/api/prompts').then(function(r){return r.json()}).catch(function(){return []}),
      fetch('/api/config').then(function(r){return r.json()}).catch(function(){return {modo:'claude'}}),
      fetch('/api/errors').then(function(r){return r.json()}).catch(function(){return []}),
      fetch('/api/prevention').then(function(r){return r.json()}).catch(function(){return []}),
      fetch('/api/health').then(function(r){return r.json()}).catch(function(){return {}}),
      fetch('/api/tips').then(function(r){return r.json()}).catch(function(){return []})
    ]);
    D=results[0];S=results[1];F=results[2];I=results[3];P=results[4];MODO=results[5].modo||'claude';
    ERRORS=results[6];PREV=results[7];HEALTH=results[8];TIPS=results[9];
    $('hdr-dot').style.background='#4ade80';
    $('hdr-st').textContent='Ativo';
  }catch(e){
    console.error(e);
    $('hdr-dot').style.background='#f87171';
    $('hdr-st').textContent='Erro';
  }
  updateNavVisibility();
  renderAll();
}

/* ── Render All ── */
function renderAll(){
  renderHeader();
  renderOverview();
  renderProductivity();
  renderCosts();
  renderProviders();
  renderPromptHist();
  renderSessions();
  renderQuality();
  renderIntelligence();
}

/* ── Header ── */
function renderHeader(){
  $('hdr-proj').textContent=D.projeto||'Nenhum projeto configurado';
  $('hdr-sess').textContent=D.sessoes?'#'+D.sessoes:'--';
  var modeEl=$('hdr-mode');
  modeEl.textContent=MODO.toUpperCase();
  modeEl.className='mode-pill mode-'+MODO;
  $('ft-mode').textContent=MODO;
  $('sum-mode').textContent=MODO==='claude'?'Claude (plano)':'Economico (providers externos)';
  $('sum-sess').textContent=D.sessoes||0;
  var fDone=F.filter(function(f){return f.status==='done'}).length;
  $('sum-fases').textContent=fDone+'/'+F.length;
  $('sum-custo').textContent=money(D.custo_real);
  var econVal=(D.custo_hipotetico||0)-(D.custo_real||0);
  $('sum-econ').textContent=econVal>0?money(econVal)+' ('+pct(D.economia_pct)+')':'--';
}

/* ── P1: Visao Geral ── */
function renderOverview(){
  var prog=D.progresso||0;
  $('v-prog').textContent=pct(prog);
  var fDone=F.filter(function(f){return f.status==='done'}).length;
  $('v-prog-s').textContent=F.length?fDone+' de '+F.length+' fases':'nenhuma fase registrada';

  $('v-tasks').textContent=D.tarefas_concluidas||0;
  $('v-tasks-s').textContent=D.sessoes?'em '+D.sessoes+' sessoes':'nenhuma sessao';

  var vel='--',velS='sem sessoes';
  if(S.length){
    var tT=S.reduce(function(a,s){return a+((s.tarefas&&s.tarefas.total)||0)},0);
    var tH=S.reduce(function(a,s){return a+((s.duracao_segundos||0)/3600)},0);
    if(tH>0){vel=(tT/tH).toFixed(1)+'/h';velS=tT+' tarefas em '+S.length+' sessoes';}
    else if(tT>0){vel=tT+'';velS=S.length+' sessoes';}
  }
  $('v-vel').textContent=vel;
  $('v-vel-s').textContent=velS;

  $('v-qual').textContent=D.conformidade?pct(D.conformidade):'--';
  $('v-qual-s').textContent=D.conformidade>0?'conforme Kit Ouro':'sem verificacao';

  // Timeline
  if(F.length){
    var sorted=F.slice().sort(function(a,b){return(a.numero||0)-(b.numero||0)});
    $('timeline').innerHTML=sorted.map(function(f){
      var s=f.status||'pending';
      var p=f.progresso_pct||0;
      var barC=s==='done'?'#22c55e':s==='current'?'#fbbf24':'#3f3f46';
      var txtC=s==='done'?'#4ade80':s==='current'?'#fbbf24':'#52525b';
      var icon=s==='done'?'[OK]':s==='current'?'[>>]':'[..]';
      return '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px"><span class="mono" style="width:24px;font-size:11px;color:#52525b">'+(f.numero||'')+'</span><div class="ph-t" style="flex:1"><div class="ph-f" style="width:'+p+'%;background:'+barC+'"></div></div><span style="width:140px;font-size:11px;color:'+txtC+'">'+icon+' '+(f.nome||'Fase '+f.numero)+'</span></div>';
    }).join('');
  }else{$('timeline').innerHTML=em('Nenhuma fase registrada');}

  // Alertas
  var al=D.alertas||[];
  $('alerts-t').textContent=al.length?'Alertas ('+al.length+')':'Alertas';
  if(al.length){
    $('alerts-box').innerHTML=al.map(function(a){
      if(typeof a==='string')return '<div class="al al-w">'+a+'</div>';
      var cls=a.tipo==='ok'?'al-ok':a.tipo==='info'?'al-i':'al-w';
      return '<div class="al '+cls+'">'+(a.mensagem||JSON.stringify(a))+'</div>';
    }).join('');
  }else{$('alerts-box').innerHTML='<div class="al al-ok">Nenhum alerta ativo</div>';}
}

/* ── P2: Produtividade ── */
function renderProductivity(){
  var hoje=new Date().toISOString().slice(0,10);
  var semAgo=new Date(Date.now()-7*86400000).toISOString().slice(0,10);

  // Tarefas hoje/semana
  var tHoje=0,tSem=0;
  S.forEach(function(s){
    var d=(s.timestamp||'').slice(0,10);
    var t=(s.tarefas&&s.tarefas.concluidas)||0;
    if(d===hoje)tHoje+=t;
    if(d>=semAgo)tSem+=t;
  });
  $('pr-today').textContent=tHoje;
  $('pr-week').textContent=tSem;

  // Velocidade media
  var totalT=S.reduce(function(a,s){return a+((s.tarefas&&s.tarefas.total)||0)},0);
  var totalH=S.reduce(function(a,s){return a+((s.duracao_segundos||0)/3600)},0);
  $('pr-speed').textContent=totalH>0?(totalT/totalH).toFixed(1)+'/h':'--';

  // Streak
  var days={};
  S.forEach(function(s){var d=(s.timestamp||'').slice(0,10);if(d)days[d]=true;});
  var streak=0;
  var checkDate=new Date();
  for(var i=0;i<60;i++){
    var ds=checkDate.toISOString().slice(0,10);
    if(days[ds]){streak++;}else if(i>0){break;}
    checkDate.setDate(checkDate.getDate()-1);
  }
  $('pr-streak').textContent=streak;
  $('pr-streak-s').textContent=streak===1?'dia consecutivo':'dias consecutivos';

  // Heatmap (14 dias)
  var hm='';
  for(var j=13;j>=0;j--){
    var dd=new Date(Date.now()-j*86400000).toISOString().slice(0,10);
    var has=days[dd];
    hm+='<div class="day '+(has?'active':'empty')+'" title="'+dd+'"></div>';
  }
  $('pr-heatmap').innerHTML=hm;

  // Atividade por dia
  var act=[];
  for(var k=6;k>=0;k--){
    var ddd=new Date(Date.now()-k*86400000);
    var ds2=ddd.toISOString().slice(0,10);
    var cnt=0;
    S.forEach(function(s){if((s.timestamp||'').slice(0,10)===ds2)cnt+=(s.tarefas&&s.tarefas.concluidas)||0;});
    act.push({day:['Dom','Seg','Ter','Qua','Qui','Sex','Sab'][ddd.getDay()],count:cnt});
  }
  var maxAct=Math.max.apply(null,act.map(function(a){return a.count}).concat([1]));
  $('pr-activity').innerHTML=act.map(function(a){
    return '<div class="cr"><div class="cl">'+a.day+'</div><div class="cb"><div style="width:'+Math.max(a.count/maxAct*100,3)+'%;background:#fbbf24"></div></div><div class="cv mono" style="color:#fbbf24">'+a.count+'</div></div>';
  }).join('');

  // Tarefas por fase
  if(F.length){
    var maxFT=Math.max.apply(null,F.map(function(f){return(f.tarefas&&f.tarefas.total)||0}).concat([1]));
    $('pr-by-phase').innerHTML=F.slice().sort(function(a,b){return(a.numero||0)-(b.numero||0)}).map(function(f){
      var t2=(f.tarefas&&f.tarefas.total)||0;
      var ok2=(f.tarefas&&f.tarefas.concluidas)||0;
      return '<div class="cr"><div class="cl">'+(f.nome||'Fase '+f.numero)+'</div><div class="cb"><div style="width:'+Math.max(t2/maxFT*100,3)+'%;background:#fbbf24"></div></div><div class="cv mono" style="color:#e4e4e7">'+ok2+'/'+t2+'</div></div>';
    }).join('');
  }else{$('pr-by-phase').innerHTML=em('Nenhuma fase registrada');}

  // Metricas
  var conf=D.conformidade||0;
  var econPct=D.economia_pct||0;
  var metrics=[
    {n:'Velocidade',v:totalH>0?(totalT/totalH).toFixed(1)+'/h':'--',m:'>5/h',ok:totalH>0&&(totalT/totalH)>=5},
    {n:'Qualidade Kit',v:pct(conf),m:'>90%',ok:conf>=90},
    {n:'Economia',v:pct(econPct),m:'>80%',ok:econPct>=80||MODO==='claude'},
    {n:'Streak',v:streak+' dias',m:'>3 dias',ok:streak>=3}
  ];
  $('pr-metrics').innerHTML=metrics.map(function(m){
    var badge=m.ok?'<span class="b b-g">OK</span>':'<span class="b b-y">Atentar</span>';
    return '<tr><td>'+m.n+'</td><td class="tc mono">'+m.v+'</td><td class="tc" style="color:#71717a">'+m.m+'</td><td class="tc">'+badge+'</td></tr>';
  }).join('');

  // Sessoes recentes mini
  if(S.length){
    $('pr-recent').innerHTML=S.slice(0,5).map(function(s){
      var d=(s.timestamp||'').slice(0,10);
      var t3=(s.tarefas&&s.tarefas.concluidas)||0;
      var dur=s.duracao_segundos?Math.round(s.duracao_segundos/60)+'min':'--';
      return '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #18181b;font-size:12px"><span style="color:#71717a">'+d+'</span><span class="mono">'+t3+' tarefas</span><span class="mono" style="color:#52525b">'+dur+'</span></div>';
    }).join('');
  }else{$('pr-recent').innerHTML=em('Nenhuma sessao');}
}

/* ── P3: Economia ── */
function renderCosts(){
  $('ec-real').textContent=money(D.custo_real);
  $('ec-hip').textContent=money(D.custo_hipotetico);
  var sv=(D.custo_hipotetico||0)-(D.custo_real||0);
  $('ec-save').textContent=money(sv);
  $('ec-pct').textContent=D.economia_pct?pct(D.economia_pct):'0%';

  if(I.length){
    var maxC=Math.max.apply(null,I.map(function(ia){return ia.custo_total||0}).concat([0.01]));
    $('ec-by-ia').innerHTML=I.slice().sort(function(a,b){return(b.custo_total||0)-(a.custo_total||0)}).map(function(ia){
      var v=ia.custo_total||0;
      return '<div class="cr"><div class="cl">'+(ia.nome||'--')+'</div><div class="cb"><div style="width:'+Math.max(v>0?v/maxC*100:3,3)+'%;background:'+(v>0?'#fbbf24':'#22c55e')+'"></div></div><div class="cv mono" style="color:'+(v>0?'#fbbf24':'#4ade80')+'">'+(v>0?money(v):'gratis')+'</div></div>';
    }).join('');
  }else{$('ec-by-ia').innerHTML=em('Nenhuma IA registrada');}

  if(F.length){
    var maxFC=Math.max.apply(null,F.map(function(f){return(f.custo&&f.custo.real)||0}).concat([0.01]));
    $('ec-by-fase').innerHTML=F.slice().sort(function(a,b){return((b.custo&&b.custo.real)||0)-((a.custo&&a.custo.real)||0)}).map(function(f){
      var v=(f.custo&&f.custo.real)||0;
      return '<div class="cr"><div class="cl">'+(f.nome||'Fase '+f.numero)+'</div><div class="cb"><div style="width:'+Math.max(v>0?v/maxFC*100:3,3)+'%;background:'+(v>0?'#fbbf24':'#22c55e')+'"></div></div><div class="cv mono" style="color:'+(v>0?'#fbbf24':'#4ade80')+'">'+(v>0?money(v):'gratis')+'</div></div>';
    }).join('');
  }else{$('ec-by-fase').innerHTML=em('Nenhuma fase registrada');}

  var prog=D.progresso||0;
  if(prog>0&&(D.custo_real||0)>0){
    var eR=D.custo_real/(prog/100);
    var eH=(D.custo_hipotetico||0)/(prog/100);
    var eS=eH-eR;
    var eP=eH>0?((eS/eH)*100):0;
    $('ec-proj').innerHTML='<div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Total Estimado</div><div style="font-size:22px;font-weight:700;color:#fbbf24" class="mono">'+money(eR)+'</div></div><div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Sem Kit Ouro</div><div style="font-size:22px;font-weight:700;color:#f87171" class="mono">'+money(eH)+'</div></div><div><div style="font-size:11px;color:#71717a;text-transform:uppercase;margin-bottom:4px">Economia Projetada</div><div style="font-size:22px;font-weight:700;color:#4ade80" class="mono">'+money(eS)+'</div><span class="b b-g mono">'+pct(eP)+'</span></div>';
  }else{$('ec-proj').innerHTML='<div style="grid-column:1/-1">'+em('Precisa de progresso e custo para projetar')+'</div>';}
}

/* ── P4: Providers ── */
function renderProviders(){
  if(I.length){
    $('tbl-ias').innerHTML=I.map(function(a){
      var suc=a.taxa_sucesso_pct||0;
      var lat=a.latencia_media_s?(a.latencia_media_s.toFixed(1)+'s'):'--';
      var custo=(a.custo_total||0)>0?money(a.custo_total):'gratis';
      var custoC=(a.custo_total||0)>0?'#fbbf24':'#4ade80';
      var sucC=suc>=95?'#4ade80':suc>=90?'#fbbf24':'#f87171';
      var devC=(a.desvios_encontrados||0)===0?'#4ade80':'#f87171';
      return '<tr><td style="font-weight:500">'+a.nome+'</td><td class="tc mono">'+(a.chamadas_total||0)+'</td><td class="tc mono" style="color:'+sucC+'">'+pct(suc)+'</td><td class="tc mono">'+lat+'</td><td class="tc"><span class="mono" style="color:'+custoC+'">'+custo+'</span></td><td class="tc" style="color:'+devC+'">'+(a.desvios_encontrados||0)+'</td></tr>';
    }).join('');
    var recs=[];
    I.forEach(function(ia){
      if((ia.desvios_encontrados||0)>2)recs.push({t:'w',m:ia.nome+': '+ia.desvios_encontrados+' desvios'});
      if((ia.taxa_sucesso_pct||0)>=95&&(ia.custo_total||0)===0)recs.push({t:'ok',m:ia.nome+': '+pct(ia.taxa_sucesso_pct)+' sucesso a custo zero'});
      if((ia.taxa_sucesso_pct||0)<90)recs.push({t:'w',m:ia.nome+': sucesso '+pct(ia.taxa_sucesso_pct)+' (abaixo de 90%)'});
    });
    $('ias-recs').innerHTML=recs.length?recs.map(function(r){return '<div class="al al-'+(r.t==='ok'?'ok':'w')+'">'+r.m+'</div>'}).join(''):'<div class="al al-ok">Todos os providers operando normalmente</div>';
  }else{
    $('tbl-ias').innerHTML='<tr><td colspan="6">'+em('Nenhum provider registrado')+'</td></tr>';
    $('ias-recs').innerHTML=em('Sem dados');
  }
}

/* ── P5: Prompts ── */
function renderPromptHist(){
  if(P.length){
    $('promptHist').innerHTML=P.slice(0,20).map(function(p){
      var time=p.timestamp?new Date(p.timestamp).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'--';
      return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #18181b"><span class="mono" style="font-size:11px;color:#52525b;width:40px">'+time+'</span><span style="font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">"'+(p.input_usuario||'--')+'"</span><span class="b b-z mono">'+(p.tipo||'--')+'</span></div>';
    }).join('');
  }else{$('promptHist').innerHTML=em('Nenhum prompt gerado');}
}

/* ── P6: Sessoes ── */
function renderSessions(){
  if(S.length){
    $('tbl-sess').innerHTML=S.slice(0,20).map(function(s){
      var data=s.timestamp?new Date(s.timestamp).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}):(s.sessao_id||'--');
      var secs=s.duracao_segundos||0;
      var dur=secs>0?(Math.floor(secs/3600)+'h'+String(Math.floor((secs%3600)/60)).padStart(2,'0')):'--';
      var tarefas=(s.tarefas&&s.tarefas.total)||0;
      var custo=(s.custo&&s.custo.real)||0;
      var ias=(s.ias_utilizadas||[]).map(function(ia){return '<span class="b b-z mono">'+(ia.nome||'').slice(0,6)+'</span> '}).join('')||'--';
      return '<tr><td class="mono" style="color:#fbbf24;font-size:11px">'+data+'</td><td class="tc mono" style="font-size:11px">'+dur+'</td><td class="tc mono" style="font-size:11px">'+tarefas+'</td><td class="tc mono" style="color:#fbbf24;font-size:11px">'+money(custo)+'</td><td style="font-size:11px">'+ias+'</td></tr>';
    }).join('');
  }else{$('tbl-sess').innerHTML='<tr><td colspan="5">'+em('Nenhuma sessao registrada')+'</td></tr>';}
}

/* ── P7: Qualidade ── */
function renderQuality(){
  var conf=D.conformidade||0;
  $('q-bar').style.width=conf+'%';
  $('q-pct').textContent=conf>0?pct(conf):'--';

  var desvios=[];var counter=1;
  I.forEach(function(ia){
    (ia.desvios_detalhados||[]).forEach(function(d){
      desvios.push({id:counter++,tipo:d.tipo||'--',ia:ia.nome,fase:d.fase||'--',status:d.status||'pendente'});
    });
  });

  if(desvios.length){
    $('tbl-dev').innerHTML=desvios.map(function(d){
      var badge=d.status==='corrigido'?'<span class="b b-g mono">corrigido</span>':'<span class="b b-y mono">pendente</span>';
      return '<tr><td class="mono" style="color:#52525b;font-size:11px">'+d.id+'</td><td style="font-size:12px">'+d.tipo+'</td><td><span class="b b-z mono">'+d.ia+'</span></td><td class="tc mono" style="font-size:11px">'+d.fase+'</td><td>'+badge+'</td></tr>';
    }).join('');

    var tipos={};desvios.forEach(function(d){tipos[d.tipo]=(tipos[d.tipo]||0)+1});
    var tipoArr=Object.keys(tipos).map(function(k){return{n:k,c:tipos[k]}}).sort(function(a,b){return b.c-a.c});
    var total=desvios.length;var acc=0;
    var dC=['#ef4444','#fbbf24','#3b82f6','#6b7280','#a855f7'];
    var parts=tipoArr.map(function(t,i){var p=t.c/total*100;var s=acc;acc+=p;return{n:t.n,p:p,s:s,c:dC[i%dC.length]}});
    var conic=parts.map(function(p){return p.c+' '+p.s+'% '+(p.s+p.p)+'%'}).join(',');
    $('ch-dev').innerHTML='<div class="donut" style="background:conic-gradient('+conic+')"><div class="donut-c" style="width:80px;height:80px;background:#18181b;border-radius:50%;display:flex;align-items:center;justify-content:center"><span style="font-size:11px;color:#71717a">'+total+'</span></div></div><div class="legend">'+parts.map(function(p){return '<span style="color:'+p.c+'">'+p.n+' '+p.p.toFixed(0)+'%</span>'}).join('')+'</div>';
  }else{
    $('tbl-dev').innerHTML='<tr><td colspan="5">'+em('Nenhum desvio encontrado')+'</td></tr>';
    $('ch-dev').innerHTML=em('Sem desvios');
  }

  if(I.length){
    var qr=[];
    I.forEach(function(ia){
      if((ia.desvios_encontrados||0)>2)qr.push({t:'w',m:'Reforcar padroes para '+ia.nome+' ('+ia.desvios_encontrados+' desvios)'});
      if((ia.desvios_encontrados||0)===0&&(ia.chamadas_total||0)>5)qr.push({t:'ok',m:ia.nome+': 0 desvios em '+(ia.chamadas_total||0)+' chamadas'});
    });
    $('q-recs').innerHTML=qr.length?qr.map(function(r){return '<div class="al al-'+(r.t==='ok'?'ok':'w')+'">'+r.m+'</div>'}).join(''):'<div class="al al-ok">Sem recomendacoes pendentes</div>';
  }else{$('q-recs').innerHTML=em('Sem dados');}
}

/* ── P8: Inteligencia ── */
function renderIntelligence(){
  var score=HEALTH.total||0;
  var grade=HEALTH.grade||'--';
  var ringColor=score>=80?'#4ade80':score>=60?'#fbbf24':'#f87171';
  $('intel-health-ring').style.background='conic-gradient('+ringColor+' '+(score*3.6)+'deg, #27272a 0deg)';
  $('intel-health-val').textContent=score;
  $('intel-health-val').style.color=ringColor;

  $('intel-errors-count').textContent=ERRORS.length;
  $('intel-prevention-count').textContent=PREV.length;
  $('intel-tips-count').textContent=TIPS.length;

  // AI Insights: top tips
  if(TIPS.length){
    var catMap={Performance:'perf',Quality:'qual',Organization:'org',Prevention:'prev',Economy:'econ'};
    $('intel-insights').innerHTML=TIPS.slice(0,5).map(function(t){
      var cls='cat-'+(catMap[t.categoria]||'qual');
      return '<div class="tip-card"><span class="cat-badge '+cls+'">'+t.categoria+'</span><div><div style="font-size:13px;color:#e4e4e7">'+t.mensagem+'</div>'+(t.acao?'<div style="font-size:11px;color:#71717a;margin-top:4px">→ '+t.acao+'</div>':'')+'</div></div>';
    }).join('');
  }else{
    $('intel-insights').innerHTML=em('Sem insights ainda. Registre erros e sessoes para gerar dicas.');
  }

  // Error distribution bars
  if(ERRORS.length){
    var cats={};
    ERRORS.forEach(function(e){cats[e.categoria]=(cats[e.categoria]||0)+1});
    var catArr=Object.keys(cats).map(function(k){return{name:k,count:cats[k]}}).sort(function(a,b){return b.count-a.count});
    var maxE=catArr[0].count;
    var catColors={logic:'#6366f1',runtime:'#f87171',syntax:'#fbbf24',network:'#60a5fa',dependency:'#a855f7',config:'#06b6d4'};
    $('intel-error-dist').innerHTML=catArr.map(function(cc){
      var color=catColors[cc.name]||'#6366f1';
      return '<div class="cr"><div class="cl">'+cc.name+'</div><div class="cb"><div style="width:'+Math.max(cc.count/maxE*100,5)+'%;background:'+color+'"></div></div><div class="cv mono" style="color:#818cf8">'+cc.count+'</div></div>';
    }).join('');
  }else{
    $('intel-error-dist').innerHTML=em('Nenhum erro registrado');
  }

  // Recent errors
  if(ERRORS.length){
    var recent=ERRORS.slice(-10).reverse();
    $('intel-recent-errors').innerHTML=recent.map(function(e){
      var dots='';
      for(var d=1;d<=5;d++){dots+='<span class="'+(d<=(e.dificuldade||1)?'filled':'empty')+'"></span>';}
      var statusBadge=e.status==='resolved'?'<span class="b b-g">ok</span>':'<span class="b b-y">'+(e.status||'new')+'</span>';
      return '<div style="padding:8px 0;border-bottom:1px solid #1a1a1e;font-size:12px"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:#e4e4e7">'+(e.message||'').slice(0,50)+'</span><span class="diff-dots">'+dots+'</span>'+statusBadge+'</div>'+(e.solucao?'<div style="font-size:11px;color:#71717a;margin-top:2px">→ '+e.solucao.slice(0,70)+'</div>':'')+'</div>';
    }).join('');
  }else{
    $('intel-recent-errors').innerHTML=em('Nenhum erro registrado');
  }

  // Prevention rules table
  if(PREV.length){
    $('intel-prevention-tbl').innerHTML=PREV.map(function(r){
      var cls='sev-'+(r.severidade||'medium');
      return '<tr><td style="font-size:12px">'+(r.regra||r.trigger).slice(0,50)+'</td><td class="tc"><span class="sev-badge '+cls+'">'+(r.severidade||'medium')+'</span></td><td class="tc mono" style="font-size:11px;color:#818cf8">'+(r.matches||0)+'</td></tr>';
    }).join('');
  }else{
    $('intel-prevention-tbl').innerHTML='<tr><td colspan="3">'+em('Nenhuma regra de prevencao')+'</td></tr>';
  }

  // Error trend sparkline (14 days)
  if(ERRORS.length){
    var days=[];
    for(var i=13;i>=0;i--){
      var dd=new Date(Date.now()-i*86400000).toISOString().slice(0,10);
      var count=ERRORS.filter(function(e){return(e.timestamp||'').slice(0,10)===dd}).length;
      days.push({date:dd,count:count});
    }
    var maxVal=Math.max.apply(null,days.map(function(d){return d.count}).concat([1]));
    var w=400,h=80,pad=10;
    var stepX=(w-pad*2)/(days.length-1);
    var pts=days.map(function(d,idx){return(pad+idx*stepX)+','+(h-pad-(d.count/maxVal)*(h-pad*2))});
    var areaStart=pad+','+( h-pad);
    var areaEnd=(pad+(days.length-1)*stepX)+','+(h-pad);
    $('intel-error-trend').innerHTML='<svg viewBox="0 0 '+w+' '+h+'" style="width:100%;height:80px"><polygon points="'+areaStart+' '+pts.join(' ')+' '+areaEnd+'" fill="rgba(99,102,241,0.08)" stroke="none"/><polyline points="'+pts.join(' ')+'" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="'+(pad+(days.length-1)*stepX)+'" cy="'+pts[pts.length-1].split(',')[1]+'" r="3" fill="#818cf8"/></svg><div style="display:flex;justify-content:space-between;font-size:10px;color:#3f3f46"><span>'+days[0].date.slice(5)+'</span><span>'+days[days.length-1].date.slice(5)+'</span></div>';
  }else{
    $('intel-error-trend').innerHTML=em('Sem dados para sparkline');
  }

  // Health sub-scores
  if(HEALTH.subscores){
    var subs=HEALTH.subscores;
    $('intel-subscores').innerHTML=Object.keys(subs).map(function(key){
      var s=subs[key];
      var barColor=s.score>=80?'#4ade80':s.score>=60?'#fbbf24':'#f87171';
      var weightPct=Math.round(s.weight*100);
      return '<div class="cr" style="margin-bottom:10px"><div class="cl" style="width:110px">'+s.label+'</div><div class="cb" style="height:18px"><div style="width:'+s.score+'%;background:'+barColor+';height:100%;border-radius:7px;transition:width 0.8s ease"></div></div><div class="cv mono" style="color:'+barColor+';width:40px">'+s.score+'</div><div style="font-size:10px;color:#3f3f46;width:35px">('+weightPct+'%)</div></div>';
    }).join('');
  }else{
    $('intel-subscores').innerHTML=em('Sem dados de saude');
  }
}

/* ── Prompt Generator ── */
function gerarPrompt(){
  var t=$('promptIn').value.trim();if(!t)return;
  var b=$('btnGerar');b.textContent='Gerando...';b.disabled=true;
  setTimeout(function(){
    var tk=Math.floor(Math.random()*800+800);
    $('promptMeta').innerHTML='<span style="font-size:11px"><span style="color:#52525b">Modo:</span> <b style="color:#fbbf24">'+MODO+'</b></span><span style="font-size:11px"><span style="color:#52525b">Tipo:</span> '+$('selTipo').value+'</span><span style="font-size:11px"><span style="color:#52525b">Tokens:</span> <span class="mono">~'+tk+'</span></span>';
    $('promptOut').textContent='Role: Desenvolvedor especializado\n\nContexto: '+t.slice(0,80)+'\n\nInstrucoes:\n1. Usar APENAS componentes do Kit Ouro\n2. Seguir padroes definidos em KIT_OURO.md\n3. Responsivo e acessivel\n\nVerify:\n[ ] Componentes sao do Kit Ouro\n[ ] Padroes respeitados\n[ ] Testes passando';
    $('promptRes').style.display='block';
    b.textContent='Gerar Prompt Otimizado';b.disabled=false;
  },1000);
}

/* ── Chat Engine ── */
var CHAT_HISTORY=[];

function sendChat(){
  var msg=$('chatIn').value.trim();if(!msg)return;
  $('chatIn').value='';
  $('chat-empty')&&($('chat-empty').style.display='none');
  appendChat('user',msg);
  $('chat-status').textContent='Processando...';

  fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,history:CHAT_HISTORY})})
  .then(function(r){return r.json()})
  .then(function(data){
    $('chat-status').textContent='';
    if(!data.ok){appendChat('ai','Erro: '+(data.error||'desconhecido'));return;}
    var result=data.data;
    CHAT_HISTORY.push({role:'user',content:msg,interpretation:result.interpretation||null});

    if(result.type==='interpretation'){
      appendChat('ai','Entendi: "'+result.interpretation.summary+'".\n\n'+result.suggestions.join('\n'));
    }else if(result.type==='prompt_generated'){
      appendChat('ai','Prompt CO-STAR gerado!\nTriggers: '+(result.prompt.triggers||[]).join(', '));
      var p=result.prompt;
      $('chat-prompt').textContent='[CO-STAR Framework]\n\nContext: '+p.context+'\nObjective: '+p.objective+'\nStyle: '+p.style+'\nTone: '+p.tone+'\nAudience: '+p.audience+'\nResponse: '+p.response+(p.triggerContext?'\n\n'+p.triggerContext:'');
    }else if(result.type==='correction_needed'){
      appendChat('ai',result.message);
    }else if(result.type==='note'){
      appendChat('ai',result.message);
    }else if(result.type==='question'){
      appendChat('ai',result.message);
    }else{
      appendChat('ai',result.message||JSON.stringify(result));
    }
  })
  .catch(function(e){
    $('chat-status').textContent='';
    appendChat('ai','Erro de conexao: '+e.message);
  });
}

function appendChat(role,text){
  var box=$('chat-messages');
  var div=document.createElement('div');
  div.className='chat-msg chat-'+role;
  div.innerHTML='<div class="chat-label">'+(role==='user'?'Voce':'GSD Ouro')+'</div><div>'+text.replace(/\n/g,'<br>')+'</div>';
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

function clearChat(){
  CHAT_HISTORY=[];
  $('chat-messages').innerHTML='<div class="em" id="chat-empty">Escreva o que voce quer em linguagem natural.<br><small>Ex: "quero um botao de logout bonito no header"</small></div>';
  $('chat-prompt').textContent='Nenhum prompt gerado ainda.\nConverse no chat para gerar um prompt CO-STAR profissional.';
  fetch('/api/chat/clear',{method:'POST'});
}

function copyChatPrompt(){
  var text=$('chat-prompt').textContent;
  navigator.clipboard.writeText(text).then(function(){
    $('chat-status').textContent='Copiado!';
    setTimeout(function(){$('chat-status').textContent=''},2000);
  });
}

function saveChatPrompt(){
  var text=$('chat-prompt').textContent;
  if(text.indexOf('Nenhum')===0)return;
  fetch('/api/track/prompt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:text,source:'chat',grade:'B'})})
  .then(function(){$('chat-status').textContent='Salvo!';setTimeout(function(){$('chat-status').textContent=''},2000)});
}

function toggleConfirm(){
  var on=$('chat-confirm-toggle').checked;
  $('confirm-status').textContent=on?'Padrao: ON — Bloco CONFIRM obrigatorio antes de codificar':'DESLIGADO — Cuidado: codificacao sem confirmacao';
  $('confirm-status').style.color=on?'#3f3f46':'#f87171';
  fetch('/api/preferences',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({confirm_enabled:on})});
}

$('chatIn').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}});

/* ── Notes Engine ── */
var NOTES=[];
var NOTE_FILTER=null;

function loadNotes(){
  fetch('/api/notes').then(function(r){return r.json()}).then(function(data){
    NOTES=data||[];
    renderNotes();
    renderNoteStats();
  }).catch(function(){});
}

function addNote(){
  var text=$('noteIn').value.trim();if(!text)return;
  $('noteIn').value='';
  fetch('/api/notes',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text})})
  .then(function(r){return r.json()})
  .then(function(data){
    if(data.ok){loadNotes();}
  });
}

function filterNotes(f){
  NOTE_FILTER=f||null;
  document.querySelectorAll('[data-nf]').forEach(function(b){b.style.background='';});
  if(!f){document.querySelector('[data-nf="all"]').style.background='#3f3f46';}
  renderNotes();
}

function noteAction(id,action){
  if(action==='delete'){
    fetch('/api/notes/'+id,{method:'DELETE'}).then(function(){loadNotes()});
  }else{
    fetch('/api/notes/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({status:action})})
    .then(function(){loadNotes()});
  }
}

function renderNotes(){
  var filtered=NOTES;
  if(NOTE_FILTER==='high')filtered=NOTES.filter(function(n){return n.priority==='high'});
  if(NOTE_FILTER==='open')filtered=NOTES.filter(function(n){return n.status==='open'});
  if(NOTE_FILTER==='done')filtered=NOTES.filter(function(n){return n.status==='done'});

  if(!filtered.length){
    $('notes-list').innerHTML='<div class="em">Nenhuma nota'+(NOTE_FILTER?' com este filtro':'')+'.</div>';
    return;
  }
  $('notes-list').innerHTML=filtered.map(function(n){
    var tagCls={'bug':'t-bug','feature':'t-feature','idea':'t-idea','ui':'t-ui'};
    var tags=(n.tags||[]).map(function(t){return '<span class="note-tag '+(tagCls[t]||'')+'">'+t+'</span>'}).join('');
    var prioIcon={'high':'!!','medium':'!','low':'~'};
    var statusIcon=n.status==='done'?'<span style="color:#4ade80;font-size:11px">done</span>':n.status==='deferred'?'<span style="color:#71717a;font-size:11px">adiada</span>':'';
    return '<div class="note-item"><span class="note-prio prio-'+(n.priority||'medium')+'">'+(prioIcon[n.priority]||'!')+'</span><div class="note-text">'+n.text+'<div class="note-tags">'+tags+(n.module?'<span class="note-tag">'+n.module+'</span>':'')+'</div></div>'+statusIcon+'<div class="note-actions"><button onclick="noteAction(\''+n.id+'\',\'done\')" title="Concluir">ok</button><button onclick="noteAction(\''+n.id+'\',\'deferred\')" title="Adiar">adiar</button><button onclick="noteAction(\''+n.id+'\',\'delete\')" title="Remover">x</button></div></div>';
  }).join('');
}

function renderNoteStats(){
  if(!NOTES.length){$('notes-stats').innerHTML='<div class="em">Sem dados</div>';return;}
  var stats={total:NOTES.length,open:0,done:0,deferred:0,high:0,medium:0,low:0,tags:{}};
  NOTES.forEach(function(n){
    stats[n.status||'open']++;
    stats[n.priority||'medium']++;
    (n.tags||[]).forEach(function(t){stats.tags[t]=(stats.tags[t]||0)+1});
  });
  var tagList=Object.keys(stats.tags).sort(function(a,b){return stats.tags[b]-stats.tags[a]}).slice(0,8);
  $('notes-stats').innerHTML=
    '<div class="g3c"><div><div class="big mono" style="font-size:20px;color:#fbbf24">'+stats.total+'</div><div class="sub">Total</div></div><div><div class="big mono" style="font-size:20px;color:#4ade80">'+stats.done+'</div><div class="sub">Feitas</div></div><div><div class="big mono" style="font-size:20px;color:#f87171">'+stats.high+'</div><div class="sub">Urgentes</div></div></div>'+
    '<div style="margin-top:16px"><h2 style="font-size:12px;color:#71717a;margin-bottom:8px">Por Status</h2>'+
    '<div class="bar-t" style="margin-bottom:4px"><div class="bar-f" style="width:'+((stats.done/stats.total)*100)+'%;background:linear-gradient(90deg,#4ade80,#22c55e)"></div></div>'+
    '<div style="font-size:11px;color:#52525b">'+stats.open+' abertas / '+stats.done+' feitas / '+stats.deferred+' adiadas</div></div>'+
    '<div style="margin-top:16px"><h2 style="font-size:12px;color:#71717a;margin-bottom:8px">Tags</h2>'+
    tagList.map(function(t){return '<div style="display:flex;justify-content:space-between;font-size:12px;padding:2px 0"><span style="color:#a1a1aa">'+t+'</span><span class="mono" style="color:#fbbf24">'+stats.tags[t]+'</span></div>'}).join('')+'</div>';
}

/* ── Updates ── */
var UPDATES=[];

function loadUpdates(){
  fetch('/api/updates').then(function(r){return r.json()}).then(function(data){
    UPDATES=data||[];
    renderUpdates();
  }).catch(function(){});
}

function logUpdate(){
  var ver=$('upd-version').value.trim();
  var desc=$('upd-desc').value.trim();
  var type=$('upd-type').value;
  if(!ver||!desc)return;
  fetch('/api/updates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({version:ver,description:desc,type:type})})
  .then(function(r){return r.json()})
  .then(function(data){
    if(data.ok){$('upd-version').value='';$('upd-desc').value='';loadUpdates();}
  });
}

function renderUpdates(){
  if(!UPDATES.length){
    $('updates-list').innerHTML='<div class="em">Nenhuma atualizacao registrada.</div>';
    $('updates-summary').innerHTML='<div class="em">Sem dados</div>';
    return;
  }
  $('updates-list').innerHTML=UPDATES.slice(0,20).map(function(u){
    return '<div class="upd-item t-'+(u.type||'update')+'"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:14px;font-weight:600;color:#fbbf24" class="mono">v'+(u.version||'?')+'</span><span style="font-size:11px;color:#52525b">'+(u.date||'')+'</span></div><div style="font-size:13px;margin-top:4px;color:#a1a1aa">'+(u.description||'')+'</div><div style="margin-top:4px"><span class="b b-'+(u.type==='hotfix'?'r':u.type==='patch'?'b':'y')+'">'+(u.type||'update')+'</span></div></div>';
  }).join('');

  var versions=[...new Set(UPDATES.map(function(u){return u.version}))];
  $('updates-summary').innerHTML=
    '<div class="g3c"><div><div class="big mono" style="font-size:20px;color:#fbbf24">'+UPDATES.length+'</div><div class="sub">Total</div></div><div><div class="big mono" style="font-size:20px;color:#e4e4e7">'+versions.length+'</div><div class="sub">Versoes</div></div><div><div class="big mono" style="font-size:20px;color:#4ade80">v'+(UPDATES[0].version||'?')+'</div><div class="sub">Atual</div></div></div>';
}

/* ── Comparator ── */
var CMP_RANKING=[];
var CMP_HISTORY=[];
var CMP_PRESETS={
  codigo:['mistral:codestral-latest','deepseek:deepseek-chat'],
  debug:['deepseek:deepseek-chat','google:gemini-2.5-flash'],
  documentacao:['google:gemini-2.5-flash','deepseek:deepseek-chat'],
  refactor:['mistral:codestral-latest','deepseek:deepseek-chat'],
  rapido:['groq:llama-3.1-8b-instant','mistral:codestral-latest']
};

function toggleTarget(el){el.classList.toggle('active')}

function applyPreset(){
  var val=$('cmp-preset').value;if(!val)return;
  var targets=CMP_PRESETS[val]||[];
  document.querySelectorAll('.cmp-tg').forEach(function(el){
    var t=el.getAttribute('data-t');
    el.classList.toggle('active',targets.indexOf(t)!==-1);
  });
  $('cmp-cat').value=val==='rapido'?'geral':val;
}

function getSelectedTargets(){
  var targets=[];
  document.querySelectorAll('.cmp-tg.active').forEach(function(el){
    targets.push(el.getAttribute('data-t'));
  });
  return targets;
}

function runComparison(){
  var prompt=$('cmp-prompt').value.trim();
  if(!prompt){$('cmp-status').textContent='Digite um prompt primeiro';return;}
  var targets=getSelectedTargets();
  if(targets.length<2){$('cmp-status').textContent='Selecione pelo menos 2 targets';return;}

  var btn=$('btn-compare');
  btn.textContent='Comparando...';btn.disabled=true;
  $('cmp-status').textContent='Enviando para '+targets.length+' providers em paralelo...';

  var body={prompt:prompt,targets:targets};
  var cat=$('cmp-cat').value;
  if(cat)body.category=cat;

  fetch('/api/compare',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
  .then(function(r){return r.json()})
  .then(function(data){
    btn.textContent='Comparar';btn.disabled=false;
    if(!data.ok){$('cmp-status').textContent='Erro: '+(data.error||'desconhecido');return;}
    $('cmp-status').textContent='Concluido em '+data.data.results.reduce(function(m,r){return Math.max(m,r.latency_ms)},0)+'ms (max)';
    renderComparisonResult(data.data);
    loadComparatorData();
  })
  .catch(function(e){
    btn.textContent='Comparar';btn.disabled=false;
    $('cmp-status').textContent='Erro: '+e.message;
  });
}

function renderComparisonResult(data){
  $('cmp-results-section').style.display='block';

  if(data.winner){
    $('cmp-winner').innerHTML='<div style="display:flex;align-items:center;gap:12px"><span style="font-size:11px;color:#71717a">VENCEDOR</span><span style="font-size:16px;font-weight:700;color:#f59e0b">'+data.winner.provider+':'+data.winner.model+'</span><span class="mono" style="font-size:14px;color:#4ade80">Score '+data.winner.score+'</span></div>';
  }

  var scoreColor=function(s){return s>=80?'#4ade80':s>=60?'#fbbf24':s>=40?'#f97316':'#f87171'};
  var dims=['relevance','completeness','clarity','latency','cost'];
  var dimLabels={relevance:'Relevancia',completeness:'Completude',clarity:'Clareza',latency:'Velocidade',cost:'Custo'};

  $('cmp-cards').innerHTML=data.results.map(function(r,i){
    var isWinner=data.winner&&r.provider===data.winner.provider&&r.model===data.winner.model;
    var sc=r.score;
    var bars=dims.map(function(d){
      var val=sc.breakdown[d]||0;
      var col=scoreColor(val);
      return '<div style="display:flex;align-items:center;gap:6px;font-size:11px"><span style="width:72px;color:#71717a">'+dimLabels[d]+'</span><div class="cmp-bar" style="flex:1"><div class="cmp-bar-fill" style="width:'+val+'%;background:'+col+'"></div></div><span class="mono" style="width:24px;text-align:right;color:'+col+'">'+val+'</span></div>';
    }).join('');

    var tokIn=(r.tokens&&r.tokens.input)||0;
    var tokOut=(r.tokens&&r.tokens.output)||0;
    var content=r.content?(r.content.length>300?r.content.slice(0,300)+'...':r.content):'(erro)';

    return '<div class="cmp-card'+(isWinner?' winner':'')+'">'+
      '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'+
        '<div><span style="font-weight:600;color:'+(isWinner?'#f59e0b':'#e4e4e7')+'">'+r.provider+'</span><span style="color:#52525b;font-size:12px"> : '+r.model+'</span></div>'+
        (isWinner?'<span style="font-size:10px;background:#f59e0b;color:#000;padding:2px 8px;border-radius:8px;font-weight:600">BEST</span>':'')+
      '</div>'+
      '<div class="cmp-score mono" style="color:'+scoreColor(sc.total)+'">'+sc.total+'<span style="font-size:12px;color:#52525b"> /100</span></div>'+
      '<div style="margin:12px 0">'+bars+'</div>'+
      '<div style="display:flex;gap:12px;font-size:11px;color:#52525b;border-top:1px solid #27272a;padding-top:8px;margin-top:8px">'+
        '<span>'+r.latency_ms+'ms</span>'+
        '<span>'+tokIn+' in / '+tokOut+' out</span>'+
        '<span class="'+(r.status==='ok'?'':'')+'">'+r.status+'</span>'+
      '</div>'+
      '<details style="margin-top:8px"><summary style="font-size:11px;color:#71717a;cursor:pointer">Ver resposta</summary><pre style="font-size:11px;color:#a1a1aa;white-space:pre-wrap;margin-top:8px;padding:8px;background:#09090b;border-radius:6px;max-height:200px;overflow-y:auto">'+escHtml(content)+'</pre></details>'+
    '</div>';
  }).join('');
}

function escHtml(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function loadComparatorData(){
  Promise.all([
    fetch('/api/compare/ranking').then(function(r){return r.json()}).catch(function(){return []}),
    fetch('/api/compare/history').then(function(r){return r.json()}).catch(function(){return []}),
    fetch('/api/compare/recommendations').then(function(r){return r.json()}).catch(function(){return {}})
  ]).then(function(results){
    CMP_RANKING=results[0];
    CMP_HISTORY=results[1];
    renderRanking();
    renderCmpHistory();
    renderRecommendations(results[2]);
  });
}

function renderRanking(){
  if(!CMP_RANKING.length){$('cmp-ranking').innerHTML='<div class="em">Execute comparacoes para gerar ranking</div>';return;}
  var scoreColor=function(s){return s>=80?'#4ade80':s>=60?'#fbbf24':s>=40?'#f97316':'#f87171'};
  $('cmp-ranking').innerHTML='<table><thead><tr><th>#</th><th>Provider</th><th class="tc">Score</th><th class="tc">Wins</th><th class="tc">Win%</th><th class="tc">Latencia</th></tr></thead><tbody>'+
    CMP_RANKING.map(function(r){
      return '<tr><td style="color:#f59e0b;font-weight:600">'+r.rank+'</td><td><span style="color:#e4e4e7">'+r.provider+'</span><span style="color:#52525b;font-size:11px">:'+r.model+'</span></td><td class="tc mono" style="color:'+scoreColor(r.avg_score)+'">'+r.avg_score+'</td><td class="tc mono">'+r.wins+'/'+r.comparisons+'</td><td class="tc mono" style="color:'+scoreColor(r.win_rate)+'">'+r.win_rate+'%</td><td class="tc mono" style="color:#71717a">'+r.avg_latency+'ms</td></tr>';
    }).join('')+'</tbody></table>';
}

function renderCmpHistory(){
  if(!CMP_HISTORY.length){$('cmp-history').innerHTML='<div class="em">Sem comparacoes ainda</div>';return;}
  $('cmp-history').innerHTML=CMP_HISTORY.slice(0,10).map(function(h){
    var winner=h.winner?h.winner.provider+':'+h.winner.model:'—';
    var winScore=h.winner?h.winner.score:'—';
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #1a1a1e;font-size:12px">'+
      '<div style="flex:1;color:#a1a1aa;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px" title="'+escHtml(h.prompt_preview)+'">'+escHtml(h.prompt_preview)+'</div>'+
      '<span class="mono" style="color:#f59e0b;min-width:60px;text-align:center">'+winner.split(':')[0]+'</span>'+
      '<span class="mono" style="color:#4ade80;min-width:30px;text-align:right">'+winScore+'</span>'+
      '<span style="color:#3f3f46;min-width:60px;text-align:right">'+(h.timestamp||'').slice(5,16)+'</span>'+
    '</div>';
  }).join('');
}

function renderRecommendations(recs){
  if(!recs||!Object.keys(recs).length){$('cmp-recommendations').innerHTML='<div class="em">Execute comparacoes para obter recomendacoes</div>';return;}
  var cats=['codigo','debug','refactor','testes','documentacao','geral'];
  var items=[];
  cats.forEach(function(cat){
    var r=recs[cat];
    if(r&&r.recommendation){
      items.push('<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1e;font-size:12px">'+
        '<span style="color:#71717a;width:80px">'+cat+'</span>'+
        '<span style="color:#f59e0b;font-weight:600">'+r.recommendation.split(':')[0]+'</span>'+
        '<span class="mono" style="color:#4ade80">'+r.score+'</span>'+
        '<span class="mono" style="color:#71717a;font-size:10px">'+r.win_rate+'% wins</span>'+
      '</div>');
    }
  });
  $('cmp-recommendations').innerHTML=items.length?items.join(''):'<div class="em">Sem dados suficientes</div>';
}

/* ── Init ── */
load();
loadNotes();
loadUpdates();
loadComparatorData();
setInterval(load,30000);
</script>
</body>
</html>
